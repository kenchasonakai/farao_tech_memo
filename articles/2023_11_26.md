# インスタクローン
## config
ruby version -> `3.1.0`

rails version -> `7.0.2.2`

## initial commit
`§ rbenv install 3.1.0`
`$ rbenv global 3.1.0` もしくはこれに準ずるコマンドでrubyのバージョン3.1.0に切り替える
`$ gem install rails -v 7.0.2.2`
`$ rails _7.0.1_ new insta_clone --css bootstrap`

* Gemfileの変更 開発環境用のgroupにforemanを追加

```
group :development do
  # Use console on exceptions pages [https://github.com/rails/web-console]
  gem "web-console"
  gem "foreman" # bin/devコマンドで必要なため追加

  # Add speed badges [https://github.com/MiniProfiler/rack-mini-profiler]
  # gem "rack-mini-profiler"

  # Speed up commands on slow machines / big apps [https://github.com/rails/spring]
  # gem "spring"
end
```

## Postモデル・コントローラー・ルーティングの作成
`$ rails g resource Post`を使っていろいろまとめて作成する

* routes.rbに追加されたPost用のルーティングの確認とルート用のルーティング設定の追加

```ruby
Rails.application.routes.draw do
  root "post#index" # ルート用のルーティング設定を追加
  resources :posts # コマンドによって追加される
end
```

* 作成した`db/migrate/************_create_posts.rb`の編集(*部分は作成日によって変わります)

```ruby
class CreatePosts < ActiveRecord::Migration[7.0]
  def change
    create_table :posts do |t|
      t.string :caption # 画像の説明用カラムを追加

      t.timestamps
    end
  end
end
```

`$ rails db:migrate`でmigrationの設定を反映

* `app/controllers/posts_controller.rb`確認用にindexアクションを追加

```ruby
class PostsController < ApplicationController
  def index
  end
end
```

* PostsControllerのindexアクションに対応するViewを追加

`app/views/posts/index.html.erb`ファイルを作成する
```erb
<h1>表示確認用</h1>
```

* 表示の確認

`$ bin/dev`でサーバーを起動する
`http://localhost:3000/posts`にアクセスして先ほど追加した`表示確認用`の見出しが表示されているか確認する

[![Image from Gyazo](https://t.gyazo.com/teams/startup-technology/7049a81cf11898854980d822cdd0dc64.png)](https://startup-technology.gyazo.com/7049a81cf11898854980d822cdd0dc64)

## ActiveStorage用のテーブルを追加
`$ rails active_storage:install`
`$ rails db:migrate`

## PostモデルでActiveStorageを使えるように設定する
`$ brew install vips`

* `app/models/posts.rb`に設定 これだけでActiveStorageにアップロードした画像とPostモデルが勝手に紐づく

```ruby
class Post < ApplicationRecord
  has_one_attached :image # 追加
  validates :image, presence: true # 追加
  validates :caption, length: { maximum: 191 } # 追加
end
```

* `app/controllers/posts_controller.rb`にPostの新規投稿用フォームを表示するためのnewアクションとPost作成用のcreateアクションを追加して、投稿一覧画面用にindexアクションを編集

```ruby
class PostsController < ApplicationController
  def index
    @posts = Post.all.order(created_at: :desc) # 追加
  end

  # 追加
  def new
    @post = Post.new
  end

  # 追加
  def create
    @post = Post.new(image: params[:post][:image], caption: params[:post][:caption])
    if @post.save
      redirect_to posts_path
    else
      render :new
    end
  end
end
```

* `app/views/posts/new.html.erb`ファイルを作成してPost投稿用のフォームを追加

```erb
<%= form_with model: @post do |f| %>
  <%= f.file_field :image %>
  <%= f.text_field :caption %>
  <%= f.submit '作成' %>
<% end %>
```

* `app/views/posts/index.html.erb`ファイルを編集して投稿した画像一覧を表示できるようにする

```erb
<h1>表示確認用</h1>
<% @posts.each do |post| %>
  <%= image_tag post.image if post.image.attached? %>
<% end %>
```

* `http://localhost:3000/posts/new`から何か適当な画像をアップロードして投稿一覧画面に表示されるか見てみましょう

[![Image from Gyazo](https://t.gyazo.com/teams/startup-technology/b4310ca5ec760437add9fd3591708766.jpg)](https://startup-technology.gyazo.com/b4310ca5ec760437add9fd3591708766)

## 投稿フォームをいい感じにする
`$ rails g stimulus file`でpreviewとかに使うstimulus用のファイルを作成
`public`ディレクトリに`placeholder.png`っていう名前で画像を追加

* `app/javascript/controllers/file_controller.js`にpreview用のJSを追加する

```js
import { Controller } from "@hotwired/stimulus"

// Connects to data-controller="file"
export default class extends Controller {
  static targets = ["input", "preview"]; //要素に名前をつけて簡単に扱えるように出来る

  // ファイルを選択したらプレビュー出来るようにするJS
  preview() {
    let file = this.inputTarget.files[0];
    let reader = new FileReader();
    let preview = this.previewTarget;

    reader.onload = () => {
      preview.src = reader.result
    }

    reader.readAsDataURL(file);
  }
}
```

* `app/views/posts/new.html.erb`にいろいろデザインを当てたりJS用の設定を追加

```erb
<div class="card m-5 w-50 mx-auto">
  <div class="card-header">
    <h1 class='h3'>新規投稿を作成</h1>
  </div>
  <div class="card-body text-center" data-controller="file">
    <%= form_with model: @post, class: "form-group" do |f| %>
      <p class="mb-3">
        <%= image_tag '/placeholder.png', data: { file_target: "preview" }, style: 'height:auto;width:30%;'%>
      </p>
      <%= f.file_field :image, accept: "image/*", class: 'form-control mb-3', data: { file_target: "input", action: "change->file#preview" } %>
      <%= f.text_field :caption, placeholder: "キャプションを入力", class: "form-control mb-3"%>
      <div class="text-end">
        <%= link_to 'キャンセル', posts_path, class: "btn btn-secondary me-2" %>
        <%= f.submit 'シェア', class: "btn btn-primary text-start" %>
      </div>
    <% end %>
  </div>
</div>
```

## ViewComponentを使って一覧画面をいい感じにする
* Gemfileに`gem "view_component"`を追加

`$ bundle install`
`$ rails g component Post`

* `app/components/post_component.rb`を編集

```ruby
# frozen_string_literal: true

class PostComponent < ViewComponent::Base
  with_collection_parameter :post
  def initialize(post:)
    @post = post
  end

end
```

* `app/components/post_component.html.erb`を編集

```erb
<div class="card mb-3">
  <div class="card-header d-flex align-items-center">
    <%= image_tag '/placeholder.png', class: "img-thumbnail rounded-circle me-2", style: 'height:auto;width:50px;' %>
    <span class="h-100">user_name</span>
  </div>
  <div class="card-body">
    <%= image_tag @post.image, class: "w-100" if @post.image.attached? %>
  </div>
  <div class="card-footer bg-transparent">
    <section>
      ❤️  ✈️  🗯
    </section>
    <%= @post.caption %>
  </div>
</div>
```

* `app/views/posts/index.html.erb`を編集

```erb
<div class="m-5 mx-auto w-50">
  <%= render(PostComponent.with_collection(@posts)) %>
</div>
```

## ヘッダーを作る
* `config/routes.rb`でルート用のルーティングを設定

```ruby
Rails.application.routes.draw do
  root "posts#index" # 追加
  resources :posts
end
```

* `app/views/layouts/application.html.erb`にヘッダーを追加

```erb
<!DOCTYPE html>
<html>
  <head>
    <title>InstaClone</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  </head>

  <body>
    <nav class="navbar navbar-light bg-light">
      <div class="container-fluid d-flex mx-3">
        <%= link_to 'instaclone', root_path, class: "navbar-brand" %>
        <section>
          <span>🏠</span>
          <span>🗯</span>
          <span><%= link_to "➕", new_post_path %></span>
          <span>🧭</span>
          <span>❤️ </span>
        </section>
      </div>
    </nav>
    <%= yield %>
  </body>
</html>
```

## ユーザーモデルを追加
* Gemfileに`gem 'sorcery'`を追加

全体はこんな感じ(GitHubのURL)
`$ bundle install`

* sorceryの機能を使ってユーザーモデルを作成

`$ rails g sorcery:install`
`$ rails db:migrate`
このコマンドによって`app/models/user.rb`が作られたり`db/schema.rb`にUser用のテーブルが追加される
```ruby
# This file is auto-generated from the current state of the database. Instead
# of editing this file, please use the migrations feature of Active Record to
# incrementally modify your database, and then regenerate this schema definition.
#
# This file is the source Rails uses to define your schema when running `bin/rails
# db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to
# be faster and is potentially less error prone than running all of your
# migrations from scratch. Old migrations may fail to apply correctly if those
# migrations use external dependencies or application code.
#
# It's strongly recommended that you check this file into your version control system.

ActiveRecord::Schema[7.0].define(version: 2022_02_15_135351) do
  create_table "active_storage_attachments", force: :cascade do |t|
    t.string "name", null: false
    t.string "record_type", null: false
    t.bigint "record_id", null: false
    t.bigint "blob_id", null: false
    t.datetime "created_at", null: false
    t.index ["blob_id"], name: "index_active_storage_attachments_on_blob_id"
    t.index ["record_type", "record_id", "name", "blob_id"], name: "index_active_storage_attachments_uniqueness", unique: true
  end

  create_table "active_storage_blobs", force: :cascade do |t|
    t.string "key", null: false
    t.string "filename", null: false
    t.string "content_type"
    t.text "metadata"
    t.string "service_name", null: false
    t.bigint "byte_size", null: false
    t.string "checksum"
    t.datetime "created_at", null: false
    t.index ["key"], name: "index_active_storage_blobs_on_key", unique: true
  end

  create_table "active_storage_variant_records", force: :cascade do |t|
    t.bigint "blob_id", null: false
    t.string "variation_digest", null: false
    t.index ["blob_id", "variation_digest"], name: "index_active_storage_variant_records_uniqueness", unique: true
  end

  create_table "posts", force: :cascade do |t|
    t.string "caption"
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
  end

  # ここが追加された
  create_table "users", force: :cascade do |t|
    t.string "email", null: false
    t.string "crypted_password"
    t.string "salt"
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["email"], name: "index_users_on_email", unique: true
  end

  add_foreign_key "active_storage_attachments", "active_storage_blobs", column: "blob_id"
  add_foreign_key "active_storage_variant_records", "active_storage_blobs", column: "blob_id"
end
```

## ユーザー用のルーティングを追加
* `config/routes.rb`にユーザーデータの操作用のルーティング設定とログインログアウト操作用のルーティング設定を追加

```ruby
Rails.application.routes.draw do
  root "posts#index"
  resources :posts
  resources :users # ユーザー操作用
  get 'login', to: 'user_sessions#new', as: 'login' # ログイン画面用
  post 'login', to: "user_sessions#create" # ログイン処理用
  delete 'logout', to: 'user_sessions#destroy', as: 'logout' # ログアウト処理用
end
```

サーバーを起動して`http://localhost:3000/rails/info/routes`アクセスすると作成されたルーティング一覧が確認できます
[![Image from Gyazo](https://t.gyazo.com/teams/startup-technology/fb9ff065cfb694d8bb48d986f70ac35f.png)](https://startup-technology.gyazo.com/fb9ff065cfb694d8bb48d986f70ac35f)

## ユーザー用のコントローラーと画面を追加
`$ rails g controller users`

* `app/controllers/users_controller.rb`にユーザー登録画面とユーザー登録処理用の処理を追加

```ruby
class UsersController < ApplicationController
  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)
    if @user.save
      redirect_to posts_path
    else
      render :new
    end
  end

  private

  def user_params
    params.require(:user).permit(:email, :fullname, :username, :password)
  end
end
```

* `app/views/users/new.html.erb`にユーザー登録用の画面を追加

```erb
<div class="m-5 mx-auto w-25">
  <div class="card">
    <div class="card-body text-center p-5">
      <h1 class='h4 text-black-50 mb-4'>登録して友達の写真をチェックしよう</h1>
      <%= form_with model: @user, class: "form-group" do |f| %>
        <%= f.email_field :email, placeholder: "メールアドレス", class: "form-control mb-3" %>
        <%= f.text_field :fullname, placeholder: "フルネーム", class: "form-control mb-3" %>
        <%= f.text_field :username, placeholder: "ユーザーネーム", class: "form-control mb-3" %>
        <%= f.password_field :password, placeholder: "パスワード", class: "form-control mb-3" %>
        <%= f.submit '登録する', class: "btn btn-primary form-control" %>
      <% end %>
    </div>
  </div>
  <div class="card mt-3">
    <div class="card-body text-center p-4">
      <span>アカウントをお持ちですか？<%= link_to 'ログインする', login_path %></span>
    </div>
  </div>
<div>
```

## 保存失敗時にバリデーションエラーを表示出来るようにする
`$ rails generate component Errors`

* `app/components/errors_component.rb`にエラーが入ったインスタンスを渡す用の設定を追加

```ruby
# frozen_string_literal: true

class ErrorsComponent < ViewComponent::Base
  def initialize(object:)
    @object = object
  end
end
```

* `app/components/errors_component.html.erb`にバリデーションエラー表示用の画面を追加

```erb
<% if @object.errors.any? %>
  <div class="alert alert-danger" role="alert">
    <ul>
      <% @object.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>
```

* `app/controllers/users_controller.rb`にバリデーションエラーを表示するためのオプションを追記

```ruby
class UsersController < ApplicationController
  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)
    if @user.save
      redirect_to posts_path
    else
      render :new, status: :unprocessable_entity # 追記
    end
  end

  private

  def user_params
    params.require(:user).permit(:email, :fullname, :username, :password)
  end
end
```

* `app/views/users/new.html.erb`に`<span><%= render ErrorsComponent.new(object: @user) %><span>`を追加してエラーが表示できるようにする

```erb
<span><%= render ErrorsComponent.new(object: @user) %><span>
<div class="m-5 mx-auto w-25">
  <div class="card">
    <div class="card-body text-center p-5">
      <h1 class='h4 text-black-50 mb-4'>登録して友達の写真をチェックしよう</h1>
      <%= form_with model: @user, class: "form-group" do |f| %>
        <%= f.email_field :email, placeholder: "メールアドレス", class: "form-control mb-3" %>
        <%= f.text_field :fullname, placeholder: "フルネーム", class: "form-control mb-3" %>
        <%= f.text_field :username, placeholder: "ユーザーネーム", class: "form-control mb-3" %>
        <%= f.password_field :password, placeholder: "パスワード", class: "form-control mb-3" %>
        <%= f.submit '登録する', class: "btn btn-primary form-control" %>
      <% end %>
    </div>
  </div>
  <div class="card mt-3">
    <div class="card-body text-center p-4">
      <span>アカウントをお持ちですか？<%= link_to 'ログインする', login_path %></span>
    </div>
  </div>
<div>
```

## エラーメッセージを日本語化する
* Gemfileに`gem 'rails-i18n'`を追加(GitHubのURL)

`$ bundle install`

* i18nのデフォルトを日本語にする設定を追加

```ruby
require_relative "boot"

require "rails/all"

# Require the gems listed in Gemfile, including any gems
# you've limited to :test, :development, or :production.
Bundler.require(*Rails.groups)

module InstaClone
  class Application < Rails::Application
    # Initialize configuration defaults for originally generated Rails version.
    config.load_defaults 7.0
    config.i18n.default_locale = :ja

    # Configuration for the application, engines, and railties goes here.
    #
    # These settings can be overridden in specific environments using the files
    # in config/environments, which are processed later.
    #
    # config.time_zone = "Central Time (US & Canada)"
    # config.eager_load_paths << Rails.root.join("extras")
  end
end
```

* `config/locales/activerecord.ja.yml`ファイルを作成して翻訳を追加

```yaml
ja:
  activerecord:
    models:
      user: ユーザー
    attributes:
      user:
        email: メールアドレス
        fullname: 名前
        username: ユーザー名
        password: パスワード
```

## ログイン用のコントローラーと画面を追加
* `app/controllers/user_sessions_controller.rb`にログインログアウト用の処理を追加

```ruby
class UserSessionsController < ApplicationController
  def create
    @user = login(params[:email], params[:password])

    if @user
      redirect_back_or_to(:root, notice: 'ログインしました')
    else
      flash.now[:alert] = 'ログインに失敗しました'
      render action: 'new', status: :unprocessable_entity
    end
  end

  def destroy
    logout
    redirect_to(:root, notice: 'ログアウトしました')
  end
end
```

* `app/views/user_sessions/new.html.erb`にログイン画面を追加

```erb
<div class="m-5 mx-auto w-25">
  <div class="card">
    <div class="card-body text-center p-5">
      <h1 class='h4 text-black-50 mb-4'>登録して友達の写真をチェックしよう</h1>
      <%= form_with url: login_path, class: "form-group" do |f| %>
        <%= f.text_field :email, placeholder: "メールアドレス", class: "form-control mb-3" %>
        <%= f.password_field :password, placeholder: "パスワード", class: "form-control mb-3" %>
        <%= f.submit 'ログイン', class: "btn btn-primary form-control" %>
      <% end %>
    </div>
  </div>
  <div class="card mt-3">
    <div class="card-body text-center p-4">
      <span>アカウントをお持ちないですか？<%= link_to '登録する', new_user_path %></span>
    </div>
  </div>
<div>
```

## フラッシュメッセージを表示出来るようにする
* `app/helpers/application_helper.rb`にフラッシュメッセージ用のメソッドを追加

```ruby
def flash_message
  if alert
    content_tag(:div, alert, class: "alert alert-danger")
  elsif notice
    content_tag(:div, notice, class: "alert alert-success")
  end
end
```

* `<%= flash_message %>`を`app/views/layouts/application.html.erb`に追加してフラッシュを表示できるようにする

```erb
<!DOCTYPE html>
<html>
  <head>
    <title>InstaClone</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  </head>

  <body>
    <nav class="navbar navbar-light bg-light">
      <div class="container-fluid d-flex mx-3">
        <%= link_to 'instaclone', root_path, class: "navbar-brand" %>
        <section>
          <span>🏠</span>
          <span>🗯</span>
          <span><%= link_to "➕", new_post_path %></span>
          <span>🧭</span>
          <span>❤️ </span>
        </section>
      </div>
    </nav>
    <%= flash_message %>
    <%= yield %>
  </body>
</html>
```

* `app/controllers/posts_controller.rb`にフラッシュ用のメッセージを追記

```ruby
class PostsController < ApplicationController
  def index
    @posts = Post.all.order(created_at: :desc)
  end

  def new
    @post = Post.new
  end

  def create
    @post = Post.new(image: params[:post][:image], caption: params[:post][:caption])
    if @post.save
      redirect_to posts_path, notice: '投稿を作成しました' # flash用のメッセージを追記
    else
      flash.now[:alert] = '投稿の作成に失敗しました' # flash用のメッセージを追記
      render :new
    end
  end
end
```

* `app/controllers/users_controller.rb`にフラッシュ用のメッセージを追記

```ruby
class UsersController < ApplicationController
  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)
    if @user.save
      redirect_to login_path, notice: 'ユーザーを作成しました' # flash用のメッセージを追記
    else
      flash.now[:alert] = 'ユーザーの作成に失敗しました' # flash用のメッセージを追記
      render :new, status: :unprocessable_entity
    end
  end

  private

  def user_params
    params.require(:user).permit(:email, :fullname, :username, :password)
  end
end
```

## ログインしたらヘッダーを変えるように変更
* `app/views/layouts/application.html.erb`をログイン状態の時にヘッダーの表示を切り替えられるように変更

```erb
<% if logged_in? %>
  <span><%= link_to "ログアウト", logout_path, data: { turbo_method: :delete } %></span>
<% else %>
  <span><%= link_to "ログイン", login_path %></span>
<% end %>
```

```erb
<!DOCTYPE html>
<html>
  <head>
    <title>InstaClone</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  </head>

  <body>
    <nav class="navbar navbar-light bg-light">
      <div class="container-fluid d-flex mx-3">
        <%= link_to 'instaclone', root_path, class: "navbar-brand" %>
        <section>
          <span>🏠</span>
          <span>🗯</span>
          <span><%= link_to "➕", new_post_path %></span>
          <span>🧭</span>
          <span>❤️ </span>
          <% if logged_in? %>
            <span><%= link_to "ログアウト", logout_path, data: { turbo_method: :delete } %></span>
          <% else %>
            <span><%= link_to "ログイン", login_path %></span>
          <% end %>
        </section>
      </div>
    </nav>
    <%= flash_message %>
    <%= yield %>
  </body>
</html>
```

## 投稿とユーザーを紐づける
`$ rails g migration AddUserReferencesToPosts user:references`

`*************_add_user_references_to_posts.rb`(*は日付)ファイルが作成されてreferenceを追加する設定が書かれている
```ruby
class AddUserReferencesToPosts < ActiveRecord::Migration[7.0]
  def change
    add_reference :posts, :user, null: false, foreign_key: true
  end
end
```

`$ rails db:migrate`

* `app/controllers/posts_controller.rb`を編集して`@post = current_user.posts.build(image: params[:post][:image], caption: params[:post][:caption])`に書き換える

```ruby
class PostsController < ApplicationController
  def index
    @posts = Post.all.order(created_at: :desc)
  end

  def new
    @post = Post.new
  end

  def create
    @post = current_user.posts.build(image: params[:post][:image], caption: params[:post][:caption]) # current_userから始まるように修正
    if @post.save
      redirect_to posts_path, notice: '投稿を作成しました'
    else
      flash.now[:alert] = '投稿の作成に失敗しました'
      render :new
    end
  end
end
```

* `app/models/user.rb`に投稿との紐付け設定を追加

```ruby
class User < ApplicationRecord
  HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX = /\A[a-zA-Z0-9]+\z/
  authenticates_with_sorcery!
  validates :email, presence: true
  validates :username, presence: true, format: { with: HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX, message: "半角英数字のみ使えます" }
  validates :password, length: { minimum: 8 }, if: -> { new_record? || changes[:crypted_password] }

  has_many :posts, dependent: :destroy # 追加
end
```

* `app/models/post.rb`にユーザーとの紐付け設定を追加

```ruby
class Post < ApplicationRecord
  has_one_attached :image

  validates :image, presence: true
  validates :caption, length: { maximum: 191 }

  belongs_to :user
end
```

## ログインしたら見れるようなページに設定する
* `app/controllers/application_controller.rb`に`require_login`を追加

```ruby
class ApplicationController < ActionController::Base
  before_action :require_login

  private

  def not_authenticated
    redirect_to login_path, alert: "ログインが必要です"
  end
end
```

* `app/controllers/users_controller.rb`に`skip_before_action`を追加

```ruby
class UsersController < ApplicationController
  skip_before_action :require_login, only: %i[new create] # 追加

  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)
    if @user.save
      redirect_to login_path, notice: 'ユーザーを作成しました'
    else
      flash.now[:alert] = 'ユーザーの作成に失敗しました'
      render :new, status: :unprocessable_entity
    end
  end

  private

  def user_params
    params.require(:user).permit(:email, :fullname, :username, :password)
  end
end
```

* `app/controllers/user_sessions_controller.rb`に`skip_before_action`を追加

```ruby
class UserSessionsController < ApplicationController
  skip_before_action :require_login, only: %i[new create] # 追加

  def create
    @user = login(params[:email], params[:password])

    if @user
      redirect_back_or_to(:root, notice: 'ログインしました')
    else
      flash.now[:alert] = 'ログインに失敗しました'
      render action: 'new', status: :unprocessable_entity
    end
  end

  def destroy
    logout
    redirect_to(:root, notice: 'ログアウトしました')
  end
end
```

* `app/controllers/posts_controller.rb`に`skip_before_action`を追加

```ruby
class PostsController < ApplicationController
  skip_before_action :require_login, only: %i[index]

  def index
    @posts = Post.all.order(created_at: :desc)
  end

  def new
    @post = Post.new
  end

  def create
    @post = current_user.posts.build(image: params[:post][:image], caption: params[:post][:caption])
    if @post.save
      redirect_to posts_path, notice: '投稿を作成しました'
    else
      flash.now[:alert] = '投稿の作成に失敗しました'
      render :new
    end
  end
end
```

## ユーザーの詳細ページを追加
* `$ rails g migration AddIntroductionToUser introduction:string`でUserテーブルにintroductionを追加

`db/migrate/***********_add_introduction_to_user.rb`ファイルが追加される(*は日付)
```ruby
class AddIntroductionToUser < ActiveRecord::Migration[7.0]
  def change
    add_column :users, :introduction, :string
  end
end
```

`$ rails db:migrate`

* `app/models/user.rb`に`has_one_attached :icon`追加してアイコン写真をあげられるように変更、自己紹介用のバリデーションを追加

```ruby
class User < ApplicationRecord
  HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX = /\A[a-zA-Z0-9]+\z/
  authenticates_with_sorcery!
  has_one_attached :icon # 追加

  validates :email, presence: true
  validates :username, presence: true, format: { with: HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX, message: "半角英数字のみ使えます" }
  validates :password, length: { minimum: 8 }, if: -> { new_record? || changes[:crypted_password] }
  validates :introduction, length: { maximum: 191 } # 追加

  has_many :posts, dependent: :destroy
end
```

* `app/controllers/users_controller.rb`にshow, edit , updateアクションを追加, `user_params`にicon, introductionを追加

```ruby
class UsersController < ApplicationController
  skip_before_action :require_login, only: %i[new create show] # showを追加

  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)
    if @user.save
      redirect_to login_path, notice: 'ユーザーを作成しました'
    else
      flash.now[:alert] = 'ユーザーの作成に失敗しました'
      render :new, status: :unprocessable_entity
    end
  end

  # 追加
  def show
    @user = User.find_by(username: params[:username])
  end

  # 追加
  def edit
    @user = current_user
  end

  # 追加
  def update
    @user = current_user
    if @user.update(user_params)
      redirect_to user_path(username: current_user.username)
    else
      render :edit
    end
  end

  private

  def user_params
    params.require(:user).permit(:email, :fullname, :username, :password, :icon, :introduction) # icon, introductionを追加
  end
end
```

* `config/routes.rb`でuser用のルーティングのidをusernameに変更

```ruby
Rails.application.routes.draw do
  root "posts#index"
  resources :posts
  resources :users, param: :username # 追記
  get 'login', to: 'user_sessions#new', as: 'login'
  post 'login', to: "user_sessions#create"
  delete 'logout', to: 'user_sessions#destroy', as: 'logout'
end
```

* `app/views/users/edit.html.erb`にユーザー編集用の画面を追加

```erb
<span><%= render ErrorsComponent.new(object: @user) %><span>
<div class="m-5 mx-auto w-50">
  <div class="card">
    <div class="card-body text-center p-5">
      <h1 class='h4 text-black-50 mb-4 col'>プロフィールを編集</h1>
      <%= form_with model: @user do |f| %>
        <div class="row d-flex align-items-center" data-controller="file">
          <span class="col-3"><%= image_tag @user.icon.attached? ? @user.icon : '/placeholder.png', style: 'height:auto;width:100px;', data: { file_target: "preview" } %></span>
          <div class='h4 mb-4 col-9 text-start'>
            <p><%= @user.username %></p>
            <%= f.label :icon do %>
              <%= f.file_field :icon, accept: "image/*", class: "d-none", data: { file_target: "input", action: "change->file#preview" }%>
              <a class="fs-6">プロフィール写真を変更</a>
            <% end %>
          </div>
        </div>
        <div class="form-group row mb-3">
          <%= f.label :fullname, class: "col-3 col-form-label" %>
          <div class="col">
            <%= f.text_field :fullname, placeholder: "名前", class: "form-control" %>
          </div>
        </div>
        <div class="form-group row mb-3">
          <%= f.label :username, class: "col-3 col-form-label" %>
          <div class="col">
            <%= f.text_field :username, placeholder: "ユーザー名", class: "form-control" %>
          </div>
        </div>
        <div class="form-group row mb-3">
          <%= f.label :introduction, class: "col-3 col-form-label" %>
          <div class="col">
            <%= f.text_area :introduction, class: "form-control" %>
          </div>
        </div>
        <div class="form-group row mb-3">
          <%= f.label :email, class: "col-3 col-form-label" %>
          <div class="col">
            <%= f.email_field :email, placeholder: "メールアドレス", class: "form-control mb-3" %>
          </div>
        </div>
        <div class="form-group row mb-3">
          <span class="col-3"></span>
          <div class="text-start col">
            <%= f.submit '送信する', class: "btn btn-primary" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<div>
```

* `rails g component MyPost`でユーザー詳細画面用のコンポーネントを追加

* `app/components/my_post_component.rb`を編集

```ruby
# frozen_string_literal: true

class MyPostComponent < ViewComponent::Base
  def initialize(my_post:)
    @my_post = my_post
  end
end
```

* `app/components/my_post_component.html.erb`にユーザー詳細画面用の投稿一覧画面を追加

```erb
<div class="col-4">
  <span><%= image_tag @my_post.image, style: 'height:auto;width:250px;' %></span>
</div>
```

* `app/views/users/show.html.erb`にユーザー詳細画面を追加

```erb
<div class="w-75 mx-auto">
  <div class="d-flex justify-content-start m-5 align-items-center">
    <%= image_tag @user.icon.attached? ? @user.icon : '/placeholder.png', class: "img-thumbnail rounded-circle me-5", style: 'height:auto;width:200px;' %>
    <section class="mx-5">
      <div class="mb-3">
        <span class="h4 me-2"><%= @user.username %></span>
        <span><%= link_to "プロフィールを編集", edit_user_path(current_user.username), class: "btn btn-outline-secondary" if @user.eql?(current_user) %></span>
      </div>
      <div class="mb-3">
        <span class="me-3">投稿<%= @user.posts.size %>件</span>
        <span class="me-3">フォロワー</span>
        <span class="me-3">フォロー中</span>
      </div>
      <div>
        <p class="h4"><%= @user.fullname %></p>
        <p class="me-3"><%= @user.introduction %></p>
      </div>
    </section>
  </div>
  <hr class="w-100">
  <div class="container">
    <div class="row">
      <%= render MyPostComponent.with_collection(@user.posts) %>
    </div>
  </div>
</div>
```

* `app/components/post_component.html.erb`を編集してアイコンからユーザー詳細ページに飛べるように以下のように変更

```erb
<%= link_to user_path(username: @post.user.username), class: "card-header d-flex align-items-center link-dark", style: "text-decoration: none" do %>
  <%= image_tag @user.icon.attached? ? @user.icon : '/placeholder.png', class: "img-thumbnail rounded-circle me-3", style: 'height:auto;width:50px;' %>
  <span class="h-100"><%= @post.user.username %></span>
<% end %>
```

```erb
<div class="card mb-3">
  <%= link_to user_path(username: @post.user.username), class: "card-header d-flex align-items-center link-dark", style: "text-decoration: none" do %>
    <%= image_tag @user.icon.attached? ? @user.icon : '/placeholder.png', class: "img-thumbnail rounded-circle me-3", style: 'height:auto;width:50px;' %>
    <span class="h-100"><%= @post.user.username %></span>
  <% end %>
  <div class="card-body">
    <%= image_tag @post.image, class: "w-100" if @post.image.attached? %>
  </div>
  <div class="card-footer bg-transparent">
    <section>
      ❤️  ✈️  🗯
    </section>
    <%= @post.caption %>
  </div>
</div>
```

* `config/locales/activerecord.ja.yml`に自己紹介用の翻訳を追加

```yaml
ja:
  activerecord:
    models:
      user: ユーザー
    attributes:
      user:
        email: メールアドレス
        fullname: 名前
        username: ユーザー名
        password: パスワード
        introduction: 自己紹介 # 追加
```

## スタイルの調整とアイコンの使用
* `package.json`の`build:css`を変更して`application.scss`を読み込むように変更

```json
{
  "name": "app",
  "private": "true",
  "dependencies": {
    "@hotwired/stimulus": "^3.0.1",
    "@hotwired/turbo-rails": "^7.1.1",
    "@popperjs/core": "^2.11.2",
    "bootstrap": "^5.1.3",
    "esbuild": "^0.14.21",
    "sass": "^1.49.7"
  },
  "scripts": {
    "build": "esbuild app/javascript/*.* --bundle --sourcemap --outdir=app/assets/builds",
    "build:css": "sass ./app/assets/stylesheets/application.scss ./app/assets/builds/application.css --no-source-map --load-path=node_modules"
  }
}
```

* `app/assets/stylesheets/application.scss`を作成してこの中でbootstrap用のscssを読み込むように変更

```scss
@import "./application.bootstrap.scss";
@import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css");

body{
  background-color: #fafafa;
}
```

* `app/components/post_component.html.erb`のキャプションを微修正、アイコンに差し替え

```erb
<section>
  <i class="bi bi-balloon-heart h4 me-3"></i>
  <i class="bi bi-chat h4 me-3"></i>
  <i class="bi bi-send h4"></i>
</section>
<% if @post.caption.present? %>
  <div class="py-3">
    <span class="me-1 h6"><%= @post.user.username%></span>
    <span><%= @post.caption %></span>
  </div>
<% end %>
```

```erb
<div class="card mb-3">
  <%= link_to user_path(username: @post.user.username), class: "card-header d-flex align-items-center link-dark", style: "text-decoration: none" do %>
    <%= image_tag '/placeholder.png', class: "img-thumbnail rounded-circle me-3", style: 'height:auto;width:50px;' %>
    <span class="h-100"><%= @post.user.username %></span>
  <% end %>
  <div class="card-body">
    <%= image_tag @post.image, class: "w-100" if @post.image.attached? %>
  </div>
  <div class="card-footer bg-transparent">
    <section>
      <i class="bi bi-balloon-heart h4 me-3"></i>
      <i class="bi bi-chat h4 me-3"></i>
      <i class="bi bi-send h4"></i>
    </section>
    <% if @post.caption.present? %>
      <div class="py-3">
        <span class="me-1 h6"><%= @post.user.username%></span>
        <span><%= @post.caption %></span>
      </div>
    <% end %>
  </div>
</div>
```

* `app/views/layouts/application.html.erb`絵文字をアイコンに差し替え

```erb
<nav class="navbar navbar-light bg-white border-bottom">
  <div class="container-fluid d-flex mx-auto w-75">
    <%= link_to 'instaclone', root_path, class: "navbar-brand" %>
    <section>
      <span class="me-3">
        <%= link_to  root_path, style: "text-decoration: none" do %>
          <i class="bi bi-house-door h4 text-black"></i>
        <% end %>
      </span>
      <span class="me-3"><i class="bi bi-chat-text h4"></i></span>
      <span class="me-3">
        <%= link_to  new_post_path, style: "text-decoration: none" do %>
          <i class="bi bi-plus-square h4 text-black"></i>
        <% end %>
      </span>
      <span class="me-3"><i class="bi bi-compass h4"></i></span>
      <span class="me-3"><i class="bi bi-heart h4"></i></span>
      <% if logged_in? %>
        <span><%= link_to "ログアウト", logout_path, data: { turbo_method: :delete } %></span>
      <% else %>
        <span><%= link_to "ログイン", login_path %></span>
      <% end %>
    </section>
  </div>
</nav>
```

```erb
<!DOCTYPE html>
<html>
  <head>
    <title>InstaClone</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  </head>

  <body>
    <nav class="navbar navbar-light bg-white border-bottom">
      <div class="container-fluid d-flex mx-auto w-75">
        <%= link_to 'instaclone', root_path, class: "navbar-brand" %>
        <section>
          <span class="me-3">
            <%= link_to  root_path, style: "text-decoration: none" do %>
              <i class="bi bi-house-door h4 text-black"></i>
            <% end %>
          </span>
          <span class="me-3"><i class="bi bi-chat-text h4"></i></span>
          <span class="me-3">
            <%= link_to  new_post_path, style: "text-decoration: none" do %>
              <i class="bi bi-plus-square h4 text-black"></i>
            <% end %>
          </span>
          <span class="me-3"><i class="bi bi-compass h4"></i></span>
          <span class="me-3"><i class="bi bi-heart h4"></i></span>
          <% if logged_in? %>
            <span><%= link_to "ログアウト", logout_path, data: { turbo_method: :delete } %></span>
          <% else %>
            <span><%= link_to "ログイン", login_path %></span>
          <% end %>
        </section>
      </div>
    </nav>
    <%= flash_message %>
    <%= yield %>
  </body>
</html>
```

* `app/views/users/show.html.erb`のマージンを`<div class="container mt-5">`に微修正

```erb
<div class="w-75 mx-auto">
  <div class="d-flex justify-content-start m-5 align-items-center">
    <%= image_tag '/placeholder.png', class: "img-thumbnail rounded-circle me-5", style: 'height:auto;width:200px;' %>
    <section class="mx-5">
      <div class="mb-3">
        <span class="h4 me-2"><%= @user.username %></span>
        <span><%= link_to "プロフィールを編集", edit_user_path(current_user.username), class: "btn btn-outline-secondary" if @user.eql?(current_user) %></span>
      </div>
      <div class="mb-3">
        <span class="me-3">投稿<%= @user.posts.size %>件</span>
        <span class="me-3">フォロワー</span>
        <span class="me-3">フォロー中</span>
      </div>
      <div>
        <p class="h4"><%= @user.fullname %></p>
        <p class="me-3"><%= @user.introduction %></p>
      </div>
    </section>
  </div>
  <hr class="w-100">
  <div class="container mt-5">
    <div class="row">
      <%= render MyPostComponent.with_collection(@user.posts) %>
    </div>
  </div>
</div>
```

## いいね用のModelを追加
`rails g model Like`

* `db/migrate/*************_create_likes.rb`を編集する

```ruby
class CreateLikes < ActiveRecord::Migration[7.0]
  def change
    create_table :likes do |t|
      t.references :user, foreign_key: true, null: false # 追加
      t.references :post, foreign_key: true, null: false # 追加

      t.timestamps
    end
    add_index :likes, [:user_id, :post_id], unique: true # 追加
  end
end
```

`$ rails db:migrate`

* `app/models/user.rb`を編集する

```ruby
class User < ApplicationRecord
  HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX = /\A[a-zA-Z0-9]+\z/
  authenticates_with_sorcery!
  has_one_attached :icon

  validates :email, presence: true
  validates :username, presence: true, format: { with: HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX, message: "半角英数字のみ使えます" }
  validates :password, length: { minimum: 8 }, if: -> { new_record? || changes[:crypted_password] }
  validates :introduction, length: { maximum: 191 }

  has_many :posts, dependent: :destroy
  has_many :likes, dependent: :destroy # 追加する
end
```

* `app/models/post.rb`

```ruby
class Post < ApplicationRecord
  has_one_attached :image

  validates :image, presence: true
  validates :caption, length: { maximum: 191 }

  belongs_to :user
  has_many :likes, dependent: :destroy # 追加する
end
```

* `app/models/like.rb`

```ruby
class Like < ApplicationRecord
  validates :post_id, uniqueness: { scope: :user_id } # 追加する

  belongs_to :user # 追加する
  belongs_to :post # 追加する
end
```

## いいね用のルーティングを設定
* `config/routes.rb`

```ruby
Rails.application.routes.draw do
  root "posts#index"
  resources :posts do # 下の一行をdo endで囲んであげる感じに修正
    resource :like, only: %i[create destroy] # 追加
  end
  resources :users, param: :username
  get 'login', to: 'user_sessions#new', as: 'login'
  post 'login', to: "user_sessions#create"
  delete 'logout', to: 'user_sessions#destroy', as: 'logout'
end
```

## いいね用のコントローラーを作成
* `rails g controller Likes --skip-template-engine`
* `app/controllers/likes_controller.rb`

```ruby
class LikesController < ApplicationController
  def create
    post = Post.find(params[:post_id])
    current_user.likes.create!(post: post)
    redirect_back fallback_location: posts_path
  end

  def destroy
    post = Post.find(params[:post_id])
    like = current_user.likes.find_by(post_id: post.id)
    like.destroy!
    redirect_back fallback_location: posts_path, status: :see_other
  end
end
```

## いいね用の表示を追加して置き換える
`rails g component Like`
* `app/components/like_component.rb`を編集

```ruby
# frozen_string_literal: true

class LikeComponent < ViewComponent::Base
  def initialize(post:, current_user:)
    @post = post
    @current_user = current_user
  end
end
```

* `app/components/like_component.html.erb`を編集

```erb
<% if @current_user.present? && @post.likes.exists?(user_id: @current_user.id) %>
  <%= link_to post_like_path(@post), data: { turbo_method: :delete }, style: "text-decoration: none" do %>
    <i class="bi bi-balloon-heart-fill h4 me-3 text-danger"></i>
  <% end %>
<% else %>
  <%= link_to post_like_path(@post), data: { turbo_method: :post }, style: "text-decoration: none" do %>
    <i class="bi bi-balloon-heart h4 me-3 text-black"></i>
  <% end %>
<% end %>
```

* `app/views/posts/index.html.erb`で`current_user`の情報を渡せるように編集

```erb
<div class="m-5 mx-auto w-50">
  <%= render PostComponent.with_collection(@posts, current_user: current_user) %>
</div>
```

* `app/components/post_component.rb`で`current_user`の情報を受け取れるように編集

```ruby
# frozen_string_literal: true

class PostComponent < ViewComponent::Base
  with_collection_parameter :post
  def initialize(post:, current_user:) # current_userを追加
    @post = post
    @current_user = current_user # @current_userを追加
  end
end
```

* `app/components/post_component.html.erb`のいいねアイコンのところをいいね用のViewComponentに置き換え

```erb
<div class="card mb-3">
  <%= link_to user_path(username: @post.user.username), class: "card-header d-flex align-items-center link-dark", style: "text-decoration: none" do %>
    <%= image_tag @post.user.icon.attached? ? @post.user.icon : '/placeholder.png', class: "img-thumbnail rounded-circle me-3", style: 'height:auto;width:50px;' %>
    <span class="h-100"><%= @post.user.username %></span>
  <% end %>
  <div class="card-body">
    <%= image_tag @post.image, class: "w-100" if @post.image.attached? %>
  </div>
  <div class="card-footer bg-transparent">
    <section>
      <%= render LikeComponent.new(post: @post, current_user: @current_user) %>
      <i class="bi bi-chat h4 me-3"></i>
      <i class="bi bi-send h4"></i>
    </section>
    <% if @post.caption.present? %>
      <div class="py-3">
        <span class="me-1 h6"><%= @post.user.username%></span>
        <span><%= @post.caption %></span>
      </div>
    <% end %>
  </div>
</div>
```

## 投稿にいいねしたユーザー名を表示する
* `app/components/post_component.html.erb`を編集

```erb
<div class="card mb-3">
  <%= link_to user_path(username: @post.user.username), class: "card-header d-flex align-items-center link-dark fw-bold", style: "text-decoration: none" do %>
    <%= image_tag @post.user.icon.attached? ? @post.user.icon : '/placeholder.png', class: "img-thumbnail rounded-circle me-3", style: 'height:auto;width:50px;' %>
    <span class="h-100"><%= @post.user.username %></span>
  <% end %>
  <div class="card-body">
    <%= image_tag @post.image, class: "w-100" if @post.image.attached? %>
  </div>
  <div class="card-footer bg-transparent">
    <section>
      <%= render LikeComponent.new(post: @post, current_user: @current_user) %>
      <i class="bi bi-chat h4 me-3"></i>
      <i class="bi bi-send h4"></i>
    </section>
    <div class="my-2">
      <% if @post.likes.present? %>
        <div class="py-3">
          <span class="me-1 h6 fw-bold"><%= link_to username = @post.likes.last.user.username, user_path(username: username),class: "text-decoration-none text-black" %></span>
          <span class="me-1 h6">、<span class="h6 fw-bold">その他</span>が「いいね！」しました</span>
        </div>
      <% end %>
      <% if @post.caption.present? %>
        <div>
          <span class="me-1 h6"><%= @post.user.username %></span>
          <span><%= @post.caption %></span>
        </div>
      <% end %>
      <p class="text-muted mt-3"><%= @post.created_at.strftime('%-m月%-d日') %></p>
    </div>
  </div>
</div>
```

## フォロー用のモデルを作成する
* `$ rails g model Follow`
* `db/migrate/************_create_follows.rb`を編集する

```ruby
class CreateFollows < ActiveRecord::Migration[7.0]
  def change
    create_table :follows do |t|
      t.integer :from_user_id, null: false
      t.integer :to_user_id, null: false

      t.timestamps
      t.index :from_user_id
      t.index :to_user_id
      t.index [:from_user_id, :to_user_id], unique: true
    end
  end
end
```
* `rails db:migrate`

## モデルにフォロー用の関係性を設定する
* `app/models/follow.rb`

```ruby
class Follow < ApplicationRecord
  belongs_to :to_user, class_name: "User"
  belongs_to :from_user, class_name: "User"

  validates :to_user_id, uniqueness: { scope: :from_user_id, message: "すでにフォローしています" }
end
```

* `app/models/user.rb`

```ruby
class User < ApplicationRecord
  HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX = /\A[a-zA-Z0-9]+\z/
  authenticates_with_sorcery!
  has_one_attached :icon

  validates :email, presence: true
  validates :username, presence: true, format: { with: HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX, message: "半角英数字のみ使えます" }
  validates :password, length: { minimum: 8 }, if: -> { new_record? || changes[:crypted_password] }
  validates :introduction, length: { maximum: 191 }

  has_many :posts, dependent: :destroy
  has_many :likes, dependent: :destroy
  has_many :follow_relationships, class_name: "Follow", foreign_key: :from_user_id, dependent: :destroy
  has_many :followed_relationships, class_name: "Follow", foreign_key: :to_user_id, dependent: :destroy
  has_many :followings, through: :follow_relationships, source: :to_user
  has_many :followers, through: :followed_relationships, source: :from_user
end
```

## フォロー用のルーティングを設定する
* `config/routes.rb`

```ruby
Rails.application.routes.draw do
  root "posts#index"
  resources :posts do
    resource :like, only: %i[create destroy]
  end
  resources :users, param: :username
  get 'login', to: 'user_sessions#new', as: 'login'
  post 'login', to: "user_sessions#create"
  delete 'logout', to: 'user_sessions#destroy', as: 'logout'
  resources :follows, only: [:create, :destroy] # 追加
end
```

## フォロー用のコントローラーを作成する
* `$ rails g controller Follows --skip-template-engine`

```ruby
class FollowsController < ApplicationController
  def create
    current_user.follow_relationships.create(to_user_id: params[:user_id])
    redirect_back fallback_location: root_path
  end

  def destroy
    current_user.follow_relationships.find_by(to_user_id: params[:id]).destroy
    redirect_back fallback_location: root_path, status: :see_other
  end
end
```

## ユーザー詳細ページにフォローボタンを追加する
* `app/models/user.rb`に対象のユーザーをフォロー済みかを判定するロジックを追加

```ruby
class User < ApplicationRecord
  HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX = /\A[a-zA-Z0-9]+\z/
  authenticates_with_sorcery!
  has_one_attached :icon

  validates :email, presence: true
  validates :username, presence: true, format: { with: HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX, message: "半角英数字のみ使えます" }
  validates :password, length: { minimum: 8 }, if: -> { new_record? || changes[:crypted_password] }
  validates :introduction, length: { maximum: 191 }

  has_many :posts, dependent: :destroy
  has_many :likes, dependent: :destroy
  has_many :follow_relationships, class_name: "Follow", foreign_key: :from_user_id, dependent: :destroy
  has_many :followed_relationships, class_name: "Follow", foreign_key: :to_user_id, dependent: :destroy
  has_many :followings, through: :follow_relationships, source: :to_user
  has_many :followers, through: :followed_relationships, source: :from_user

  def following?(user_id) # 追加
    User.find(user_id).in?(followings) # 追加
  end # 追加
end
```

* `app/views/users/show.html.erb`で自分の詳細ページならプロフィールを編集、それ以外はフォロー用のボタンを表示するようにして、フォロワー人数を表示出来るようにした

```ruby
<div class="w-75 mx-auto">
  <div class="d-flex justify-content-start m-5 align-items-center">
    <%= image_tag @user.icon.attached? ? @user.icon : '/placeholder.png', class: "img-thumbnail rounded-circle me-5", style: 'height:auto;width:200px;' %>
    <section class="mx-5">
      <div class="mb-3">
        <span class="h4 me-3"><%= @user.username %></span>
        <span>
          <% if @user.eql?(current_user) %>
            <%= link_to "プロフィールを編集", edit_user_path(current_user.username), class: "btn btn-outline-secondary" %>
          <% elsif current_user&.following?(@user.id) %>
            <%= link_to 'フォロー中', follow_path(@user), data: { turbo_method: :delete }, class: "btn btn-secondary btn-sm" %>
          <% else %>
            <%= link_to 'フォローする', follows_path(user_id: @user.id), data: { turbo_method: :post }, class: "btn btn-primary btn-sm" %>
          <% end %>
        </span>
      </div>
      <div class="mb-3">
        <span class="me-3">投稿<%= @user.posts.size %>件</span>
        <span class="me-3">フォロワー<%= @user.followers.size %>人</span>
        <span class="me-3">フォロー中<%= @user.followings.size %>人</span>
      </div>
      <div>
        <p class="h4"><%= @user.fullname %></p>
        <p class="me-3"><%= @user.introduction %></p>
      </div>
    </section>
  </div>
  <hr class="w-100">
  <div class="container mt-5">
    <div class="row">
      <%= render MyPostComponent.with_collection(@user.posts) %>
    </div>
  </div>
</div>
```

## 投稿がなかった場合に表示するユーザー一覧ページを作成する
* `$ rails generate component User`

* `app/controllers/users_controller.rb`

```ruby
class UsersController < ApplicationController
  skip_before_action :require_login, only: %i[new create show]

  def index # 追加
    @users = User.where.not(id: User.first.followings.pluck(:id).push(User.first.id)) # 追加
  end # 追加

  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)
    if @user.save
      redirect_to login_path, notice: 'ユーザーを作成しました'
    else
      flash.now[:alert] = 'ユーザーの作成に失敗しました'
      render :new, status: :unprocessable_entity
    end
  end

  def show
    @user = User.find_by(username: params[:username])
  end

  def edit
    @user = current_user
  end

  def update
    @user = current_user
    if @user.update(user_params)
      redirect_to user_path(username: current_user.username)
    else
      render :edit
    end
  end

  private

  def user_params
    params.require(:user).permit(:email, :fullname, :username, :password, :icon, :introduction)
  end
end
```

* `app/components/user_component.rb`

```ruby
# frozen_string_literal: true

class UserComponent < ViewComponent::Base
  def initialize(user:, current_user:)
    @user = user
    @current_user = current_user
  end
end
```

* `app/components/user_component.html.erb`

```erb
<div class="d-flex justify-content-between mb-3">
  <div>
    <%= image_tag @user.icon.attached? ? @user.icon : '/placeholder.png', class: "img-thumbnail rounded-circle me-1", style: 'height:auto;width:35px;' %>
    <%= @user.username %>
  </div>
  <div>
  <% if @current_user.following?(@user.id) %>
    <%= link_to 'フォロー中', follow_path(@user), data: { turbo_method: :delete }, class: "btn btn-secondary btn-sm" %>
  <% else %>
    <%= link_to 'フォローする', follows_path(user_id: @user.id), data: { turbo_method: :post }, class: "btn btn-primary btn-sm" %>
  <% end %>
  </div>
</div>
```

* `app/views/users/index.html.erb`を作成する

```erb
<div class="m-5 mx-auto w-25">
  <div class="card">
    <div class="card-body">
      <div class='h4 text-black-50 mb-4 text-center card-header bg-transparent'>
        友達を見つけよう
      </div>
      <%= render UserComponent.with_collection(@users, current_user: current_user) %>
    </div>
  </div>
<div>
```

## 投稿一覧ページを自分がフォローしたユーザーの投稿のみ表示されるように変更
* `app/models/post.rb`

```ruby
class Post < ApplicationRecord
  has_one_attached :image

  validates :image, presence: true
  validates :caption, length: { maximum: 191 }

  belongs_to :user
  has_many :likes, dependent: :destroy

  scope :followed_by, -> (user){ where(user_id: user.following_ids.push(user.id)) } # 追加
end
```

* `app/controllers/posts_controller.rb`

```ruby
class PostsController < ApplicationController
  skip_before_action :require_login, only: %i[index]

  def index
    if current_user.present? # 変更
      @posts = Post.followed_by(current_user).order(created_at: :desc) # 変更
    else # 変更
      @posts = Post.all.order(created_at: :desc) # 変更
    end # 変更
  end

  def new
    @post = Post.new
  end

  def create
    @post = current_user.posts.build(image: params[:post][:image], caption: params[:post][:caption])
    if @post.save
      redirect_to posts_path, notice: '投稿を作成しました'
    else
      flash.now[:alert] = '投稿の作成に失敗しました'
      render :new
    end
  end
end
```

* `app/views/posts/index.html.erb`

```erb
<div class="m-5 mx-auto w-50">
  <% if @posts.exists? %>
    <%= render PostComponent.with_collection(@posts, current_user: current_user) %>
  <% else %>
    <p>たくさんフォローしてタイムラインを面白い投稿でいっぱいにしよう</p>
    <%= link_to '友達を見つけに行く', users_path %>
  <% end %>
</div>
