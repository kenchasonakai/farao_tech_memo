# ã‚¤ãƒ³ã‚¹ã‚¿ã‚¯ãƒ­ãƒ¼ãƒ³
## config
ruby version -> `3.1.0`

rails version -> `7.0.2.2`

## initial commit
`Â§ rbenv install 3.1.0`
`$ rbenv global 3.1.0` ã‚‚ã—ãã¯ã“ã‚Œã«æº–ãšã‚‹ã‚³ãƒãƒ³ãƒ‰ã§rubyã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³3.1.0ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
`$ gem install rails -v 7.0.2.2`
`$ rails _7.0.1_ new insta_clone --css bootstrap`

* Gemfileã®å¤‰æ›´ é–‹ç™ºç’°å¢ƒç”¨ã®groupã«foremanã‚’è¿½åŠ 

```
group :development do
  # Use console on exceptions pages [https://github.com/rails/web-console]
  gem "web-console"
  gem "foreman" # bin/devã‚³ãƒãƒ³ãƒ‰ã§å¿…è¦ãªãŸã‚è¿½åŠ 

  # Add speed badges [https://github.com/MiniProfiler/rack-mini-profiler]
  # gem "rack-mini-profiler"

  # Speed up commands on slow machines / big apps [https://github.com/rails/spring]
  # gem "spring"
end
```

## Postãƒ¢ãƒ‡ãƒ«ãƒ»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãƒ»ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ä½œæˆ
`$ rails g resource Post`ã‚’ä½¿ã£ã¦ã„ã‚ã„ã‚ã¾ã¨ã‚ã¦ä½œæˆã™ã‚‹

* routes.rbã«è¿½åŠ ã•ã‚ŒãŸPostç”¨ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ç¢ºèªã¨ãƒ«ãƒ¼ãƒˆç”¨ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šã®è¿½åŠ 

```ruby
Rails.application.routes.draw do
  root "post#index" # ãƒ«ãƒ¼ãƒˆç”¨ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šã‚’è¿½åŠ 
  resources :posts # ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦è¿½åŠ ã•ã‚Œã‚‹
end
```

* ä½œæˆã—ãŸ`db/migrate/************_create_posts.rb`ã®ç·¨é›†(*éƒ¨åˆ†ã¯ä½œæˆæ—¥ã«ã‚ˆã£ã¦å¤‰ã‚ã‚Šã¾ã™)

```ruby
class CreatePosts < ActiveRecord::Migration[7.0]
  def change
    create_table :posts do |t|
      t.string :caption # ç”»åƒã®èª¬æ˜ç”¨ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 

      t.timestamps
    end
  end
end
```

`$ rails db:migrate`ã§migrationã®è¨­å®šã‚’åæ˜ 

* `app/controllers/posts_controller.rb`ç¢ºèªç”¨ã«indexã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 

```ruby
class PostsController < ApplicationController
  def index
  end
end
```

* PostsControllerã®indexã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾å¿œã™ã‚‹Viewã‚’è¿½åŠ 

`app/views/posts/index.html.erb`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹
```erb
<h1>è¡¨ç¤ºç¢ºèªç”¨</h1>
```

* è¡¨ç¤ºã®ç¢ºèª

`$ bin/dev`ã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹
`http://localhost:3000/posts`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å…ˆã»ã©è¿½åŠ ã—ãŸ`è¡¨ç¤ºç¢ºèªç”¨`ã®è¦‹å‡ºã—ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹

[![Image from Gyazo](https://t.gyazo.com/teams/startup-technology/7049a81cf11898854980d822cdd0dc64.png)](https://startup-technology.gyazo.com/7049a81cf11898854980d822cdd0dc64)

## ActiveStorageç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 
`$ rails active_storage:install`
`$ rails db:migrate`

## Postãƒ¢ãƒ‡ãƒ«ã§ActiveStorageã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹
`$ brew install vips`

* `app/models/posts.rb`ã«è¨­å®š ã“ã‚Œã ã‘ã§ActiveStorageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã¨Postãƒ¢ãƒ‡ãƒ«ãŒå‹æ‰‹ã«ç´ã¥ã

```ruby
class Post < ApplicationRecord
  has_one_attached :image # è¿½åŠ 
  validates :image, presence: true # è¿½åŠ 
  validates :caption, length: { maximum: 191 } # è¿½åŠ 
end
```

* `app/controllers/posts_controller.rb`ã«Postã®æ–°è¦æŠ•ç¨¿ç”¨ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®newã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨Postä½œæˆç”¨ã®createã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ã€æŠ•ç¨¿ä¸€è¦§ç”»é¢ç”¨ã«indexã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç·¨é›†

```ruby
class PostsController < ApplicationController
  def index
    @posts = Post.all.order(created_at: :desc) # è¿½åŠ 
  end

  # è¿½åŠ 
  def new
    @post = Post.new
  end

  # è¿½åŠ 
  def create
    @post = Post.new(image: params[:post][:image], caption: params[:post][:caption])
    if @post.save
      redirect_to posts_path
    else
      render :new
    end
  end
end
```

* `app/views/posts/new.html.erb`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦PostæŠ•ç¨¿ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿½åŠ 

```erb
<%= form_with model: @post do |f| %>
  <%= f.file_field :image %>
  <%= f.text_field :caption %>
  <%= f.submit 'ä½œæˆ' %>
<% end %>
```

* `app/views/posts/index.html.erb`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦æŠ•ç¨¿ã—ãŸç”»åƒä¸€è¦§ã‚’è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

```erb
<h1>è¡¨ç¤ºç¢ºèªç”¨</h1>
<% @posts.each do |post| %>
  <%= image_tag post.image if post.image.attached? %>
<% end %>
```

* `http://localhost:3000/posts/new`ã‹ã‚‰ä½•ã‹é©å½“ãªç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦æŠ•ç¨¿ä¸€è¦§ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‹è¦‹ã¦ã¿ã¾ã—ã‚‡ã†

[![Image from Gyazo](https://t.gyazo.com/teams/startup-technology/b4310ca5ec760437add9fd3591708766.jpg)](https://startup-technology.gyazo.com/b4310ca5ec760437add9fd3591708766)

## æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã„ã„æ„Ÿã˜ã«ã™ã‚‹
`$ rails g stimulus file`ã§previewã¨ã‹ã«ä½¿ã†stimulusç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
`public`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`placeholder.png`ã£ã¦ã„ã†åå‰ã§ç”»åƒã‚’è¿½åŠ 

* `app/javascript/controllers/file_controller.js`ã«previewç”¨ã®JSã‚’è¿½åŠ ã™ã‚‹

```js
import { Controller } from "@hotwired/stimulus"

// Connects to data-controller="file"
export default class extends Controller {
  static targets = ["input", "preview"]; //è¦ç´ ã«åå‰ã‚’ã¤ã‘ã¦ç°¡å˜ã«æ‰±ãˆã‚‹ã‚ˆã†ã«å‡ºæ¥ã‚‹

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ãŸã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡ºæ¥ã‚‹ã‚ˆã†ã«ã™ã‚‹JS
  preview() {
    let file = this.inputTarget.files[0];
    let reader = new FileReader();
    let preview = this.previewTarget;

    reader.onload = () => {
      preview.src = reader.result
    }

    reader.readAsDataURL(file);
  }
}
```

* `app/views/posts/new.html.erb`ã«ã„ã‚ã„ã‚ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å½“ã¦ãŸã‚ŠJSç”¨ã®è¨­å®šã‚’è¿½åŠ 

```erb
<div class="card m-5 w-50 mx-auto">
  <div class="card-header">
    <h1 class='h3'>æ–°è¦æŠ•ç¨¿ã‚’ä½œæˆ</h1>
  </div>
  <div class="card-body text-center" data-controller="file">
    <%= form_with model: @post, class: "form-group" do |f| %>
      <p class="mb-3">
        <%= image_tag '/placeholder.png', data: { file_target: "preview" }, style: 'height:auto;width:30%;'%>
      </p>
      <%= f.file_field :image, accept: "image/*", class: 'form-control mb-3', data: { file_target: "input", action: "change->file#preview" } %>
      <%= f.text_field :caption, placeholder: "ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’å…¥åŠ›", class: "form-control mb-3"%>
      <div class="text-end">
        <%= link_to 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', posts_path, class: "btn btn-secondary me-2" %>
        <%= f.submit 'ã‚·ã‚§ã‚¢', class: "btn btn-primary text-start" %>
      </div>
    <% end %>
  </div>
</div>
```

## ViewComponentã‚’ä½¿ã£ã¦ä¸€è¦§ç”»é¢ã‚’ã„ã„æ„Ÿã˜ã«ã™ã‚‹
* Gemfileã«`gem "view_component"`ã‚’è¿½åŠ 

`$ bundle install`
`$ rails g component Post`

* `app/components/post_component.rb`ã‚’ç·¨é›†

```ruby
# frozen_string_literal: true

class PostComponent < ViewComponent::Base
  with_collection_parameter :post
  def initialize(post:)
    @post = post
  end

end
```

* `app/components/post_component.html.erb`ã‚’ç·¨é›†

```erb
<div class="card mb-3">
  <div class="card-header d-flex align-items-center">
    <%= image_tag '/placeholder.png', class: "img-thumbnail rounded-circle me-2", style: 'height:auto;width:50px;' %>
    <span class="h-100">user_name</span>
  </div>
  <div class="card-body">
    <%= image_tag @post.image, class: "w-100" if @post.image.attached? %>
  </div>
  <div class="card-footer bg-transparent">
    <section>
      â¤ï¸  âœˆï¸  ğŸ—¯
    </section>
    <%= @post.caption %>
  </div>
</div>
```

* `app/views/posts/index.html.erb`ã‚’ç·¨é›†

```erb
<div class="m-5 mx-auto w-50">
  <%= render(PostComponent.with_collection(@posts)) %>
</div>
```

## ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œã‚‹
* `config/routes.rb`ã§ãƒ«ãƒ¼ãƒˆç”¨ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨­å®š

```ruby
Rails.application.routes.draw do
  root "posts#index" # è¿½åŠ 
  resources :posts
end
```

* `app/views/layouts/application.html.erb`ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 

```erb
<!DOCTYPE html>
<html>
  <head>
    <title>InstaClone</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  </head>

  <body>
    <nav class="navbar navbar-light bg-light">
      <div class="container-fluid d-flex mx-3">
        <%= link_to 'instaclone', root_path, class: "navbar-brand" %>
        <section>
          <span>ğŸ </span>
          <span>ğŸ—¯</span>
          <span><%= link_to "â•", new_post_path %></span>
          <span>ğŸ§­</span>
          <span>â¤ï¸ </span>
        </section>
      </div>
    </nav>
    <%= yield %>
  </body>
</html>
```

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ 
* Gemfileã«`gem 'sorcery'`ã‚’è¿½åŠ 

å…¨ä½“ã¯ã“ã‚“ãªæ„Ÿã˜(GitHubã®URL)
`$ bundle install`

* sorceryã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ

`$ rails g sorcery:install`
`$ rails db:migrate`
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦`app/models/user.rb`ãŒä½œã‚‰ã‚ŒãŸã‚Š`db/schema.rb`ã«Userç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¿½åŠ ã•ã‚Œã‚‹
```ruby
# This file is auto-generated from the current state of the database. Instead
# of editing this file, please use the migrations feature of Active Record to
# incrementally modify your database, and then regenerate this schema definition.
#
# This file is the source Rails uses to define your schema when running `bin/rails
# db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to
# be faster and is potentially less error prone than running all of your
# migrations from scratch. Old migrations may fail to apply correctly if those
# migrations use external dependencies or application code.
#
# It's strongly recommended that you check this file into your version control system.

ActiveRecord::Schema[7.0].define(version: 2022_02_15_135351) do
  create_table "active_storage_attachments", force: :cascade do |t|
    t.string "name", null: false
    t.string "record_type", null: false
    t.bigint "record_id", null: false
    t.bigint "blob_id", null: false
    t.datetime "created_at", null: false
    t.index ["blob_id"], name: "index_active_storage_attachments_on_blob_id"
    t.index ["record_type", "record_id", "name", "blob_id"], name: "index_active_storage_attachments_uniqueness", unique: true
  end

  create_table "active_storage_blobs", force: :cascade do |t|
    t.string "key", null: false
    t.string "filename", null: false
    t.string "content_type"
    t.text "metadata"
    t.string "service_name", null: false
    t.bigint "byte_size", null: false
    t.string "checksum"
    t.datetime "created_at", null: false
    t.index ["key"], name: "index_active_storage_blobs_on_key", unique: true
  end

  create_table "active_storage_variant_records", force: :cascade do |t|
    t.bigint "blob_id", null: false
    t.string "variation_digest", null: false
    t.index ["blob_id", "variation_digest"], name: "index_active_storage_variant_records_uniqueness", unique: true
  end

  create_table "posts", force: :cascade do |t|
    t.string "caption"
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
  end

  # ã“ã“ãŒè¿½åŠ ã•ã‚ŒãŸ
  create_table "users", force: :cascade do |t|
    t.string "email", null: false
    t.string "crypted_password"
    t.string "salt"
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["email"], name: "index_users_on_email", unique: true
  end

  add_foreign_key "active_storage_attachments", "active_storage_blobs", column: "blob_id"
  add_foreign_key "active_storage_variant_records", "active_storage_blobs", column: "blob_id"
end
```

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¿½åŠ 
* `config/routes.rb`ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®æ“ä½œç”¨ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šã¨ãƒ­ã‚°ã‚¤ãƒ³ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ“ä½œç”¨ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šã‚’è¿½åŠ 

```ruby
Rails.application.routes.draw do
  root "posts#index"
  resources :posts
  resources :users # ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œç”¨
  get 'login', to: 'user_sessions#new', as: 'login' # ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ç”¨
  post 'login', to: "user_sessions#create" # ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ç”¨
  delete 'logout', to: 'user_sessions#destroy', as: 'logout' # ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ç”¨
end
```

ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦`http://localhost:3000/rails/info/routes`ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä½œæˆã•ã‚ŒãŸãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä¸€è¦§ãŒç¢ºèªã§ãã¾ã™
[![Image from Gyazo](https://t.gyazo.com/teams/startup-technology/fb9ff065cfb694d8bb48d986f70ac35f.png)](https://startup-technology.gyazo.com/fb9ff065cfb694d8bb48d986f70ac35f)

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨ç”»é¢ã‚’è¿½åŠ 
`$ rails g controller users`

* `app/controllers/users_controller.rb`ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç”»é¢ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å‡¦ç†ç”¨ã®å‡¦ç†ã‚’è¿½åŠ 

```ruby
class UsersController < ApplicationController
  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)
    if @user.save
      redirect_to posts_path
    else
      render :new
    end
  end

  private

  def user_params
    params.require(:user).permit(:email, :fullname, :username, :password)
  end
end
```

* `app/views/users/new.html.erb`ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç”¨ã®ç”»é¢ã‚’è¿½åŠ 

```erb
<div class="m-5 mx-auto w-25">
  <div class="card">
    <div class="card-body text-center p-5">
      <h1 class='h4 text-black-50 mb-4'>ç™»éŒ²ã—ã¦å‹é”ã®å†™çœŸã‚’ãƒã‚§ãƒƒã‚¯ã—ã‚ˆã†</h1>
      <%= form_with model: @user, class: "form-group" do |f| %>
        <%= f.email_field :email, placeholder: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹", class: "form-control mb-3" %>
        <%= f.text_field :fullname, placeholder: "ãƒ•ãƒ«ãƒãƒ¼ãƒ ", class: "form-control mb-3" %>
        <%= f.text_field :username, placeholder: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ", class: "form-control mb-3" %>
        <%= f.password_field :password, placeholder: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", class: "form-control mb-3" %>
        <%= f.submit 'ç™»éŒ²ã™ã‚‹', class: "btn btn-primary form-control" %>
      <% end %>
    </div>
  </div>
  <div class="card mt-3">
    <div class="card-body text-center p-4">
      <span>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ã™ã‹ï¼Ÿ<%= link_to 'ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹', login_path %></span>
    </div>
  </div>
<div>
```

## ä¿å­˜å¤±æ•—æ™‚ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºå‡ºæ¥ã‚‹ã‚ˆã†ã«ã™ã‚‹
`$ rails generate component Errors`

* `app/components/errors_component.rb`ã«ã‚¨ãƒ©ãƒ¼ãŒå…¥ã£ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ¸¡ã™ç”¨ã®è¨­å®šã‚’è¿½åŠ 

```ruby
# frozen_string_literal: true

class ErrorsComponent < ViewComponent::Base
  def initialize(object:)
    @object = object
  end
end
```

* `app/components/errors_component.html.erb`ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ã®ç”»é¢ã‚’è¿½åŠ 

```erb
<% if @object.errors.any? %>
  <div class="alert alert-danger" role="alert">
    <ul>
      <% @object.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>
```

* `app/controllers/users_controller.rb`ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½è¨˜

```ruby
class UsersController < ApplicationController
  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)
    if @user.save
      redirect_to posts_path
    else
      render :new, status: :unprocessable_entity # è¿½è¨˜
    end
  end

  private

  def user_params
    params.require(:user).permit(:email, :fullname, :username, :password)
  end
end
```

* `app/views/users/new.html.erb`ã«`<span><%= render ErrorsComponent.new(object: @user) %><span>`ã‚’è¿½åŠ ã—ã¦ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

```erb
<span><%= render ErrorsComponent.new(object: @user) %><span>
<div class="m-5 mx-auto w-25">
  <div class="card">
    <div class="card-body text-center p-5">
      <h1 class='h4 text-black-50 mb-4'>ç™»éŒ²ã—ã¦å‹é”ã®å†™çœŸã‚’ãƒã‚§ãƒƒã‚¯ã—ã‚ˆã†</h1>
      <%= form_with model: @user, class: "form-group" do |f| %>
        <%= f.email_field :email, placeholder: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹", class: "form-control mb-3" %>
        <%= f.text_field :fullname, placeholder: "ãƒ•ãƒ«ãƒãƒ¼ãƒ ", class: "form-control mb-3" %>
        <%= f.text_field :username, placeholder: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ", class: "form-control mb-3" %>
        <%= f.password_field :password, placeholder: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", class: "form-control mb-3" %>
        <%= f.submit 'ç™»éŒ²ã™ã‚‹', class: "btn btn-primary form-control" %>
      <% end %>
    </div>
  </div>
  <div class="card mt-3">
    <div class="card-body text-center p-4">
      <span>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ã™ã‹ï¼Ÿ<%= link_to 'ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹', login_path %></span>
    </div>
  </div>
<div>
```

## ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥æœ¬èªåŒ–ã™ã‚‹
* Gemfileã«`gem 'rails-i18n'`ã‚’è¿½åŠ (GitHubã®URL)

`$ bundle install`

* i18nã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’æ—¥æœ¬èªã«ã™ã‚‹è¨­å®šã‚’è¿½åŠ 

```ruby
require_relative "boot"

require "rails/all"

# Require the gems listed in Gemfile, including any gems
# you've limited to :test, :development, or :production.
Bundler.require(*Rails.groups)

module InstaClone
  class Application < Rails::Application
    # Initialize configuration defaults for originally generated Rails version.
    config.load_defaults 7.0
    config.i18n.default_locale = :ja

    # Configuration for the application, engines, and railties goes here.
    #
    # These settings can be overridden in specific environments using the files
    # in config/environments, which are processed later.
    #
    # config.time_zone = "Central Time (US & Canada)"
    # config.eager_load_paths << Rails.root.join("extras")
  end
end
```

* `config/locales/activerecord.ja.yml`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ç¿»è¨³ã‚’è¿½åŠ 

```yaml
ja:
  activerecord:
    models:
      user: ãƒ¦ãƒ¼ã‚¶ãƒ¼
    attributes:
      user:
        email: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        fullname: åå‰
        username: ãƒ¦ãƒ¼ã‚¶ãƒ¼å
        password: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
```

## ãƒ­ã‚°ã‚¤ãƒ³ç”¨ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨ç”»é¢ã‚’è¿½åŠ 
* `app/controllers/user_sessions_controller.rb`ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒ­ã‚°ã‚¢ã‚¦ãƒˆç”¨ã®å‡¦ç†ã‚’è¿½åŠ 

```ruby
class UserSessionsController < ApplicationController
  def create
    @user = login(params[:email], params[:password])

    if @user
      redirect_back_or_to(:root, notice: 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ')
    else
      flash.now[:alert] = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ'
      render action: 'new', status: :unprocessable_entity
    end
  end

  def destroy
    logout
    redirect_to(:root, notice: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ')
  end
end
```

* `app/views/user_sessions/new.html.erb`ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¿½åŠ 

```erb
<div class="m-5 mx-auto w-25">
  <div class="card">
    <div class="card-body text-center p-5">
      <h1 class='h4 text-black-50 mb-4'>ç™»éŒ²ã—ã¦å‹é”ã®å†™çœŸã‚’ãƒã‚§ãƒƒã‚¯ã—ã‚ˆã†</h1>
      <%= form_with url: login_path, class: "form-group" do |f| %>
        <%= f.text_field :email, placeholder: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹", class: "form-control mb-3" %>
        <%= f.password_field :password, placeholder: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", class: "form-control mb-3" %>
        <%= f.submit 'ãƒ­ã‚°ã‚¤ãƒ³', class: "btn btn-primary form-control" %>
      <% end %>
    </div>
  </div>
  <div class="card mt-3">
    <div class="card-body text-center p-4">
      <span>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ãªã„ã§ã™ã‹ï¼Ÿ<%= link_to 'ç™»éŒ²ã™ã‚‹', new_user_path %></span>
    </div>
  </div>
<div>
```

## ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºå‡ºæ¥ã‚‹ã‚ˆã†ã«ã™ã‚‹
* `app/helpers/application_helper.rb`ã«ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 

```ruby
def flash_message
  if alert
    content_tag(:div, alert, class: "alert alert-danger")
  elsif notice
    content_tag(:div, notice, class: "alert alert-success")
  end
end
```

* `<%= flash_message %>`ã‚’`app/views/layouts/application.html.erb`ã«è¿½åŠ ã—ã¦ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚’è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

```erb
<!DOCTYPE html>
<html>
  <head>
    <title>InstaClone</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  </head>

  <body>
    <nav class="navbar navbar-light bg-light">
      <div class="container-fluid d-flex mx-3">
        <%= link_to 'instaclone', root_path, class: "navbar-brand" %>
        <section>
          <span>ğŸ </span>
          <span>ğŸ—¯</span>
          <span><%= link_to "â•", new_post_path %></span>
          <span>ğŸ§­</span>
          <span>â¤ï¸ </span>
        </section>
      </div>
    </nav>
    <%= flash_message %>
    <%= yield %>
  </body>
</html>
```

* `app/controllers/posts_controller.rb`ã«ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½è¨˜

```ruby
class PostsController < ApplicationController
  def index
    @posts = Post.all.order(created_at: :desc)
  end

  def new
    @post = Post.new
  end

  def create
    @post = Post.new(image: params[:post][:image], caption: params[:post][:caption])
    if @post.save
      redirect_to posts_path, notice: 'æŠ•ç¨¿ã‚’ä½œæˆã—ã¾ã—ãŸ' # flashç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½è¨˜
    else
      flash.now[:alert] = 'æŠ•ç¨¿ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' # flashç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½è¨˜
      render :new
    end
  end
end
```

* `app/controllers/users_controller.rb`ã«ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½è¨˜

```ruby
class UsersController < ApplicationController
  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)
    if @user.save
      redirect_to login_path, notice: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ' # flashç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½è¨˜
    else
      flash.now[:alert] = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' # flashç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½è¨˜
      render :new, status: :unprocessable_entity
    end
  end

  private

  def user_params
    params.require(:user).permit(:email, :fullname, :username, :password)
  end
end
```

## ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã‚‰ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å¤‰ãˆã‚‹ã‚ˆã†ã«å¤‰æ›´
* `app/views/layouts/application.html.erb`ã‚’ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®æ™‚ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«å¤‰æ›´

```erb
<% if logged_in? %>
  <span><%= link_to "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ", logout_path, data: { turbo_method: :delete } %></span>
<% else %>
  <span><%= link_to "ãƒ­ã‚°ã‚¤ãƒ³", login_path %></span>
<% end %>
```

```erb
<!DOCTYPE html>
<html>
  <head>
    <title>InstaClone</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  </head>

  <body>
    <nav class="navbar navbar-light bg-light">
      <div class="container-fluid d-flex mx-3">
        <%= link_to 'instaclone', root_path, class: "navbar-brand" %>
        <section>
          <span>ğŸ </span>
          <span>ğŸ—¯</span>
          <span><%= link_to "â•", new_post_path %></span>
          <span>ğŸ§­</span>
          <span>â¤ï¸ </span>
          <% if logged_in? %>
            <span><%= link_to "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ", logout_path, data: { turbo_method: :delete } %></span>
          <% else %>
            <span><%= link_to "ãƒ­ã‚°ã‚¤ãƒ³", login_path %></span>
          <% end %>
        </section>
      </div>
    </nav>
    <%= flash_message %>
    <%= yield %>
  </body>
</html>
```

## æŠ•ç¨¿ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç´ã¥ã‘ã‚‹
`$ rails g migration AddUserReferencesToPosts user:references`

`*************_add_user_references_to_posts.rb`(*ã¯æ—¥ä»˜)ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦referenceã‚’è¿½åŠ ã™ã‚‹è¨­å®šãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹
```ruby
class AddUserReferencesToPosts < ActiveRecord::Migration[7.0]
  def change
    add_reference :posts, :user, null: false, foreign_key: true
  end
end
```

`$ rails db:migrate`

* `app/controllers/posts_controller.rb`ã‚’ç·¨é›†ã—ã¦`@post = current_user.posts.build(image: params[:post][:image], caption: params[:post][:caption])`ã«æ›¸ãæ›ãˆã‚‹

```ruby
class PostsController < ApplicationController
  def index
    @posts = Post.all.order(created_at: :desc)
  end

  def new
    @post = Post.new
  end

  def create
    @post = current_user.posts.build(image: params[:post][:image], caption: params[:post][:caption]) # current_userã‹ã‚‰å§‹ã¾ã‚‹ã‚ˆã†ã«ä¿®æ­£
    if @post.save
      redirect_to posts_path, notice: 'æŠ•ç¨¿ã‚’ä½œæˆã—ã¾ã—ãŸ'
    else
      flash.now[:alert] = 'æŠ•ç¨¿ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'
      render :new
    end
  end
end
```

* `app/models/user.rb`ã«æŠ•ç¨¿ã¨ã®ç´ä»˜ã‘è¨­å®šã‚’è¿½åŠ 

```ruby
class User < ApplicationRecord
  HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX = /\A[a-zA-Z0-9]+\z/
  authenticates_with_sorcery!
  validates :email, presence: true
  validates :username, presence: true, format: { with: HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX, message: "åŠè§’è‹±æ•°å­—ã®ã¿ä½¿ãˆã¾ã™" }
  validates :password, length: { minimum: 8 }, if: -> { new_record? || changes[:crypted_password] }

  has_many :posts, dependent: :destroy # è¿½åŠ 
end
```

* `app/models/post.rb`ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ç´ä»˜ã‘è¨­å®šã‚’è¿½åŠ 

```ruby
class Post < ApplicationRecord
  has_one_attached :image

  validates :image, presence: true
  validates :caption, length: { maximum: 191 }

  belongs_to :user
end
```

## ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã‚‰è¦‹ã‚Œã‚‹ã‚ˆã†ãªãƒšãƒ¼ã‚¸ã«è¨­å®šã™ã‚‹
* `app/controllers/application_controller.rb`ã«`require_login`ã‚’è¿½åŠ 

```ruby
class ApplicationController < ActionController::Base
  before_action :require_login

  private

  def not_authenticated
    redirect_to login_path, alert: "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"
  end
end
```

* `app/controllers/users_controller.rb`ã«`skip_before_action`ã‚’è¿½åŠ 

```ruby
class UsersController < ApplicationController
  skip_before_action :require_login, only: %i[new create] # è¿½åŠ 

  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)
    if @user.save
      redirect_to login_path, notice: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ'
    else
      flash.now[:alert] = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'
      render :new, status: :unprocessable_entity
    end
  end

  private

  def user_params
    params.require(:user).permit(:email, :fullname, :username, :password)
  end
end
```

* `app/controllers/user_sessions_controller.rb`ã«`skip_before_action`ã‚’è¿½åŠ 

```ruby
class UserSessionsController < ApplicationController
  skip_before_action :require_login, only: %i[new create] # è¿½åŠ 

  def create
    @user = login(params[:email], params[:password])

    if @user
      redirect_back_or_to(:root, notice: 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ')
    else
      flash.now[:alert] = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ'
      render action: 'new', status: :unprocessable_entity
    end
  end

  def destroy
    logout
    redirect_to(:root, notice: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ')
  end
end
```

* `app/controllers/posts_controller.rb`ã«`skip_before_action`ã‚’è¿½åŠ 

```ruby
class PostsController < ApplicationController
  skip_before_action :require_login, only: %i[index]

  def index
    @posts = Post.all.order(created_at: :desc)
  end

  def new
    @post = Post.new
  end

  def create
    @post = current_user.posts.build(image: params[:post][:image], caption: params[:post][:caption])
    if @post.save
      redirect_to posts_path, notice: 'æŠ•ç¨¿ã‚’ä½œæˆã—ã¾ã—ãŸ'
    else
      flash.now[:alert] = 'æŠ•ç¨¿ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'
      render :new
    end
  end
end
```

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ 
* `$ rails g migration AddIntroductionToUser introduction:string`ã§Userãƒ†ãƒ¼ãƒ–ãƒ«ã«introductionã‚’è¿½åŠ 

`db/migrate/***********_add_introduction_to_user.rb`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚Œã‚‹(*ã¯æ—¥ä»˜)
```ruby
class AddIntroductionToUser < ActiveRecord::Migration[7.0]
  def change
    add_column :users, :introduction, :string
  end
end
```

`$ rails db:migrate`

* `app/models/user.rb`ã«`has_one_attached :icon`è¿½åŠ ã—ã¦ã‚¢ã‚¤ã‚³ãƒ³å†™çœŸã‚’ã‚ã’ã‚‰ã‚Œã‚‹ã‚ˆã†ã«å¤‰æ›´ã€è‡ªå·±ç´¹ä»‹ç”¨ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 

```ruby
class User < ApplicationRecord
  HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX = /\A[a-zA-Z0-9]+\z/
  authenticates_with_sorcery!
  has_one_attached :icon # è¿½åŠ 

  validates :email, presence: true
  validates :username, presence: true, format: { with: HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX, message: "åŠè§’è‹±æ•°å­—ã®ã¿ä½¿ãˆã¾ã™" }
  validates :password, length: { minimum: 8 }, if: -> { new_record? || changes[:crypted_password] }
  validates :introduction, length: { maximum: 191 } # è¿½åŠ 

  has_many :posts, dependent: :destroy
end
```

* `app/controllers/users_controller.rb`ã«show, edit , updateã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ , `user_params`ã«icon, introductionã‚’è¿½åŠ 

```ruby
class UsersController < ApplicationController
  skip_before_action :require_login, only: %i[new create show] # showã‚’è¿½åŠ 

  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)
    if @user.save
      redirect_to login_path, notice: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ'
    else
      flash.now[:alert] = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'
      render :new, status: :unprocessable_entity
    end
  end

  # è¿½åŠ 
  def show
    @user = User.find_by(username: params[:username])
  end

  # è¿½åŠ 
  def edit
    @user = current_user
  end

  # è¿½åŠ 
  def update
    @user = current_user
    if @user.update(user_params)
      redirect_to user_path(username: current_user.username)
    else
      render :edit
    end
  end

  private

  def user_params
    params.require(:user).permit(:email, :fullname, :username, :password, :icon, :introduction) # icon, introductionã‚’è¿½åŠ 
  end
end
```

* `config/routes.rb`ã§userç”¨ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®idã‚’usernameã«å¤‰æ›´

```ruby
Rails.application.routes.draw do
  root "posts#index"
  resources :posts
  resources :users, param: :username # è¿½è¨˜
  get 'login', to: 'user_sessions#new', as: 'login'
  post 'login', to: "user_sessions#create"
  delete 'logout', to: 'user_sessions#destroy', as: 'logout'
end
```

* `app/views/users/edit.html.erb`ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ç”¨ã®ç”»é¢ã‚’è¿½åŠ 

```erb
<span><%= render ErrorsComponent.new(object: @user) %><span>
<div class="m-5 mx-auto w-50">
  <div class="card">
    <div class="card-body text-center p-5">
      <h1 class='h4 text-black-50 mb-4 col'>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†</h1>
      <%= form_with model: @user do |f| %>
        <div class="row d-flex align-items-center" data-controller="file">
          <span class="col-3"><%= image_tag @user.icon.attached? ? @user.icon : '/placeholder.png', style: 'height:auto;width:100px;', data: { file_target: "preview" } %></span>
          <div class='h4 mb-4 col-9 text-start'>
            <p><%= @user.username %></p>
            <%= f.label :icon do %>
              <%= f.file_field :icon, accept: "image/*", class: "d-none", data: { file_target: "input", action: "change->file#preview" }%>
              <a class="fs-6">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸã‚’å¤‰æ›´</a>
            <% end %>
          </div>
        </div>
        <div class="form-group row mb-3">
          <%= f.label :fullname, class: "col-3 col-form-label" %>
          <div class="col">
            <%= f.text_field :fullname, placeholder: "åå‰", class: "form-control" %>
          </div>
        </div>
        <div class="form-group row mb-3">
          <%= f.label :username, class: "col-3 col-form-label" %>
          <div class="col">
            <%= f.text_field :username, placeholder: "ãƒ¦ãƒ¼ã‚¶ãƒ¼å", class: "form-control" %>
          </div>
        </div>
        <div class="form-group row mb-3">
          <%= f.label :introduction, class: "col-3 col-form-label" %>
          <div class="col">
            <%= f.text_area :introduction, class: "form-control" %>
          </div>
        </div>
        <div class="form-group row mb-3">
          <%= f.label :email, class: "col-3 col-form-label" %>
          <div class="col">
            <%= f.email_field :email, placeholder: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹", class: "form-control mb-3" %>
          </div>
        </div>
        <div class="form-group row mb-3">
          <span class="col-3"></span>
          <div class="text-start col">
            <%= f.submit 'é€ä¿¡ã™ã‚‹', class: "btn btn-primary" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<div>
```

* `rails g component MyPost`ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ç”»é¢ç”¨ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿½åŠ 

* `app/components/my_post_component.rb`ã‚’ç·¨é›†

```ruby
# frozen_string_literal: true

class MyPostComponent < ViewComponent::Base
  def initialize(my_post:)
    @my_post = my_post
  end
end
```

* `app/components/my_post_component.html.erb`ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ç”»é¢ç”¨ã®æŠ•ç¨¿ä¸€è¦§ç”»é¢ã‚’è¿½åŠ 

```erb
<div class="col-4">
  <span><%= image_tag @my_post.image, style: 'height:auto;width:250px;' %></span>
</div>
```

* `app/views/users/show.html.erb`ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ç”»é¢ã‚’è¿½åŠ 

```erb
<div class="w-75 mx-auto">
  <div class="d-flex justify-content-start m-5 align-items-center">
    <%= image_tag @user.icon.attached? ? @user.icon : '/placeholder.png', class: "img-thumbnail rounded-circle me-5", style: 'height:auto;width:200px;' %>
    <section class="mx-5">
      <div class="mb-3">
        <span class="h4 me-2"><%= @user.username %></span>
        <span><%= link_to "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†", edit_user_path(current_user.username), class: "btn btn-outline-secondary" if @user.eql?(current_user) %></span>
      </div>
      <div class="mb-3">
        <span class="me-3">æŠ•ç¨¿<%= @user.posts.size %>ä»¶</span>
        <span class="me-3">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</span>
        <span class="me-3">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</span>
      </div>
      <div>
        <p class="h4"><%= @user.fullname %></p>
        <p class="me-3"><%= @user.introduction %></p>
      </div>
    </section>
  </div>
  <hr class="w-100">
  <div class="container">
    <div class="row">
      <%= render MyPostComponent.with_collection(@user.posts) %>
    </div>
  </div>
</div>
```

* `app/components/post_component.html.erb`ã‚’ç·¨é›†ã—ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã«é£›ã¹ã‚‹ã‚ˆã†ã«ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´

```erb
<%= link_to user_path(username: @post.user.username), class: "card-header d-flex align-items-center link-dark", style: "text-decoration: none" do %>
  <%= image_tag @user.icon.attached? ? @user.icon : '/placeholder.png', class: "img-thumbnail rounded-circle me-3", style: 'height:auto;width:50px;' %>
  <span class="h-100"><%= @post.user.username %></span>
<% end %>
```

```erb
<div class="card mb-3">
  <%= link_to user_path(username: @post.user.username), class: "card-header d-flex align-items-center link-dark", style: "text-decoration: none" do %>
    <%= image_tag @user.icon.attached? ? @user.icon : '/placeholder.png', class: "img-thumbnail rounded-circle me-3", style: 'height:auto;width:50px;' %>
    <span class="h-100"><%= @post.user.username %></span>
  <% end %>
  <div class="card-body">
    <%= image_tag @post.image, class: "w-100" if @post.image.attached? %>
  </div>
  <div class="card-footer bg-transparent">
    <section>
      â¤ï¸  âœˆï¸  ğŸ—¯
    </section>
    <%= @post.caption %>
  </div>
</div>
```

* `config/locales/activerecord.ja.yml`ã«è‡ªå·±ç´¹ä»‹ç”¨ã®ç¿»è¨³ã‚’è¿½åŠ 

```yaml
ja:
  activerecord:
    models:
      user: ãƒ¦ãƒ¼ã‚¶ãƒ¼
    attributes:
      user:
        email: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        fullname: åå‰
        username: ãƒ¦ãƒ¼ã‚¶ãƒ¼å
        password: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        introduction: è‡ªå·±ç´¹ä»‹ # è¿½åŠ 
```

## ã‚¹ã‚¿ã‚¤ãƒ«ã®èª¿æ•´ã¨ã‚¢ã‚¤ã‚³ãƒ³ã®ä½¿ç”¨
* `package.json`ã®`build:css`ã‚’å¤‰æ›´ã—ã¦`application.scss`ã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«å¤‰æ›´

```json
{
  "name": "app",
  "private": "true",
  "dependencies": {
    "@hotwired/stimulus": "^3.0.1",
    "@hotwired/turbo-rails": "^7.1.1",
    "@popperjs/core": "^2.11.2",
    "bootstrap": "^5.1.3",
    "esbuild": "^0.14.21",
    "sass": "^1.49.7"
  },
  "scripts": {
    "build": "esbuild app/javascript/*.* --bundle --sourcemap --outdir=app/assets/builds",
    "build:css": "sass ./app/assets/stylesheets/application.scss ./app/assets/builds/application.css --no-source-map --load-path=node_modules"
  }
}
```

* `app/assets/stylesheets/application.scss`ã‚’ä½œæˆã—ã¦ã“ã®ä¸­ã§bootstrapç”¨ã®scssã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«å¤‰æ›´

```scss
@import "./application.bootstrap.scss";
@import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css");

body{
  background-color: #fafafa;
}
```

* `app/components/post_component.html.erb`ã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’å¾®ä¿®æ­£ã€ã‚¢ã‚¤ã‚³ãƒ³ã«å·®ã—æ›¿ãˆ

```erb
<section>
  <i class="bi bi-balloon-heart h4 me-3"></i>
  <i class="bi bi-chat h4 me-3"></i>
  <i class="bi bi-send h4"></i>
</section>
<% if @post.caption.present? %>
  <div class="py-3">
    <span class="me-1 h6"><%= @post.user.username%></span>
    <span><%= @post.caption %></span>
  </div>
<% end %>
```

```erb
<div class="card mb-3">
  <%= link_to user_path(username: @post.user.username), class: "card-header d-flex align-items-center link-dark", style: "text-decoration: none" do %>
    <%= image_tag '/placeholder.png', class: "img-thumbnail rounded-circle me-3", style: 'height:auto;width:50px;' %>
    <span class="h-100"><%= @post.user.username %></span>
  <% end %>
  <div class="card-body">
    <%= image_tag @post.image, class: "w-100" if @post.image.attached? %>
  </div>
  <div class="card-footer bg-transparent">
    <section>
      <i class="bi bi-balloon-heart h4 me-3"></i>
      <i class="bi bi-chat h4 me-3"></i>
      <i class="bi bi-send h4"></i>
    </section>
    <% if @post.caption.present? %>
      <div class="py-3">
        <span class="me-1 h6"><%= @post.user.username%></span>
        <span><%= @post.caption %></span>
      </div>
    <% end %>
  </div>
</div>
```

* `app/views/layouts/application.html.erb`çµµæ–‡å­—ã‚’ã‚¢ã‚¤ã‚³ãƒ³ã«å·®ã—æ›¿ãˆ

```erb
<nav class="navbar navbar-light bg-white border-bottom">
  <div class="container-fluid d-flex mx-auto w-75">
    <%= link_to 'instaclone', root_path, class: "navbar-brand" %>
    <section>
      <span class="me-3">
        <%= link_to  root_path, style: "text-decoration: none" do %>
          <i class="bi bi-house-door h4 text-black"></i>
        <% end %>
      </span>
      <span class="me-3"><i class="bi bi-chat-text h4"></i></span>
      <span class="me-3">
        <%= link_to  new_post_path, style: "text-decoration: none" do %>
          <i class="bi bi-plus-square h4 text-black"></i>
        <% end %>
      </span>
      <span class="me-3"><i class="bi bi-compass h4"></i></span>
      <span class="me-3"><i class="bi bi-heart h4"></i></span>
      <% if logged_in? %>
        <span><%= link_to "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ", logout_path, data: { turbo_method: :delete } %></span>
      <% else %>
        <span><%= link_to "ãƒ­ã‚°ã‚¤ãƒ³", login_path %></span>
      <% end %>
    </section>
  </div>
</nav>
```

```erb
<!DOCTYPE html>
<html>
  <head>
    <title>InstaClone</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  </head>

  <body>
    <nav class="navbar navbar-light bg-white border-bottom">
      <div class="container-fluid d-flex mx-auto w-75">
        <%= link_to 'instaclone', root_path, class: "navbar-brand" %>
        <section>
          <span class="me-3">
            <%= link_to  root_path, style: "text-decoration: none" do %>
              <i class="bi bi-house-door h4 text-black"></i>
            <% end %>
          </span>
          <span class="me-3"><i class="bi bi-chat-text h4"></i></span>
          <span class="me-3">
            <%= link_to  new_post_path, style: "text-decoration: none" do %>
              <i class="bi bi-plus-square h4 text-black"></i>
            <% end %>
          </span>
          <span class="me-3"><i class="bi bi-compass h4"></i></span>
          <span class="me-3"><i class="bi bi-heart h4"></i></span>
          <% if logged_in? %>
            <span><%= link_to "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ", logout_path, data: { turbo_method: :delete } %></span>
          <% else %>
            <span><%= link_to "ãƒ­ã‚°ã‚¤ãƒ³", login_path %></span>
          <% end %>
        </section>
      </div>
    </nav>
    <%= flash_message %>
    <%= yield %>
  </body>
</html>
```

* `app/views/users/show.html.erb`ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’`<div class="container mt-5">`ã«å¾®ä¿®æ­£

```erb
<div class="w-75 mx-auto">
  <div class="d-flex justify-content-start m-5 align-items-center">
    <%= image_tag '/placeholder.png', class: "img-thumbnail rounded-circle me-5", style: 'height:auto;width:200px;' %>
    <section class="mx-5">
      <div class="mb-3">
        <span class="h4 me-2"><%= @user.username %></span>
        <span><%= link_to "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†", edit_user_path(current_user.username), class: "btn btn-outline-secondary" if @user.eql?(current_user) %></span>
      </div>
      <div class="mb-3">
        <span class="me-3">æŠ•ç¨¿<%= @user.posts.size %>ä»¶</span>
        <span class="me-3">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</span>
        <span class="me-3">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</span>
      </div>
      <div>
        <p class="h4"><%= @user.fullname %></p>
        <p class="me-3"><%= @user.introduction %></p>
      </div>
    </section>
  </div>
  <hr class="w-100">
  <div class="container mt-5">
    <div class="row">
      <%= render MyPostComponent.with_collection(@user.posts) %>
    </div>
  </div>
</div>
```

## ã„ã„ã­ç”¨ã®Modelã‚’è¿½åŠ 
`rails g model Like`

* `db/migrate/*************_create_likes.rb`ã‚’ç·¨é›†ã™ã‚‹

```ruby
class CreateLikes < ActiveRecord::Migration[7.0]
  def change
    create_table :likes do |t|
      t.references :user, foreign_key: true, null: false # è¿½åŠ 
      t.references :post, foreign_key: true, null: false # è¿½åŠ 

      t.timestamps
    end
    add_index :likes, [:user_id, :post_id], unique: true # è¿½åŠ 
  end
end
```

`$ rails db:migrate`

* `app/models/user.rb`ã‚’ç·¨é›†ã™ã‚‹

```ruby
class User < ApplicationRecord
  HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX = /\A[a-zA-Z0-9]+\z/
  authenticates_with_sorcery!
  has_one_attached :icon

  validates :email, presence: true
  validates :username, presence: true, format: { with: HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX, message: "åŠè§’è‹±æ•°å­—ã®ã¿ä½¿ãˆã¾ã™" }
  validates :password, length: { minimum: 8 }, if: -> { new_record? || changes[:crypted_password] }
  validates :introduction, length: { maximum: 191 }

  has_many :posts, dependent: :destroy
  has_many :likes, dependent: :destroy # è¿½åŠ ã™ã‚‹
end
```

* `app/models/post.rb`

```ruby
class Post < ApplicationRecord
  has_one_attached :image

  validates :image, presence: true
  validates :caption, length: { maximum: 191 }

  belongs_to :user
  has_many :likes, dependent: :destroy # è¿½åŠ ã™ã‚‹
end
```

* `app/models/like.rb`

```ruby
class Like < ApplicationRecord
  validates :post_id, uniqueness: { scope: :user_id } # è¿½åŠ ã™ã‚‹

  belongs_to :user # è¿½åŠ ã™ã‚‹
  belongs_to :post # è¿½åŠ ã™ã‚‹
end
```

## ã„ã„ã­ç”¨ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨­å®š
* `config/routes.rb`

```ruby
Rails.application.routes.draw do
  root "posts#index"
  resources :posts do # ä¸‹ã®ä¸€è¡Œã‚’do endã§å›²ã‚“ã§ã‚ã’ã‚‹æ„Ÿã˜ã«ä¿®æ­£
    resource :like, only: %i[create destroy] # è¿½åŠ 
  end
  resources :users, param: :username
  get 'login', to: 'user_sessions#new', as: 'login'
  post 'login', to: "user_sessions#create"
  delete 'logout', to: 'user_sessions#destroy', as: 'logout'
end
```

## ã„ã„ã­ç”¨ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ä½œæˆ
* `rails g controller Likes --skip-template-engine`
* `app/controllers/likes_controller.rb`

```ruby
class LikesController < ApplicationController
  def create
    post = Post.find(params[:post_id])
    current_user.likes.create!(post: post)
    redirect_back fallback_location: posts_path
  end

  def destroy
    post = Post.find(params[:post_id])
    like = current_user.likes.find_by(post_id: post.id)
    like.destroy!
    redirect_back fallback_location: posts_path, status: :see_other
  end
end
```

## ã„ã„ã­ç”¨ã®è¡¨ç¤ºã‚’è¿½åŠ ã—ã¦ç½®ãæ›ãˆã‚‹
`rails g component Like`
* `app/components/like_component.rb`ã‚’ç·¨é›†

```ruby
# frozen_string_literal: true

class LikeComponent < ViewComponent::Base
  def initialize(post:, current_user:)
    @post = post
    @current_user = current_user
  end
end
```

* `app/components/like_component.html.erb`ã‚’ç·¨é›†

```erb
<% if @current_user.present? && @post.likes.exists?(user_id: @current_user.id) %>
  <%= link_to post_like_path(@post), data: { turbo_method: :delete }, style: "text-decoration: none" do %>
    <i class="bi bi-balloon-heart-fill h4 me-3 text-danger"></i>
  <% end %>
<% else %>
  <%= link_to post_like_path(@post), data: { turbo_method: :post }, style: "text-decoration: none" do %>
    <i class="bi bi-balloon-heart h4 me-3 text-black"></i>
  <% end %>
<% end %>
```

* `app/views/posts/index.html.erb`ã§`current_user`ã®æƒ…å ±ã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã«ç·¨é›†

```erb
<div class="m-5 mx-auto w-50">
  <%= render PostComponent.with_collection(@posts, current_user: current_user) %>
</div>
```

* `app/components/post_component.rb`ã§`current_user`ã®æƒ…å ±ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ç·¨é›†

```ruby
# frozen_string_literal: true

class PostComponent < ViewComponent::Base
  with_collection_parameter :post
  def initialize(post:, current_user:) # current_userã‚’è¿½åŠ 
    @post = post
    @current_user = current_user # @current_userã‚’è¿½åŠ 
  end
end
```

* `app/components/post_component.html.erb`ã®ã„ã„ã­ã‚¢ã‚¤ã‚³ãƒ³ã®ã¨ã“ã‚ã‚’ã„ã„ã­ç”¨ã®ViewComponentã«ç½®ãæ›ãˆ

```erb
<div class="card mb-3">
  <%= link_to user_path(username: @post.user.username), class: "card-header d-flex align-items-center link-dark", style: "text-decoration: none" do %>
    <%= image_tag @post.user.icon.attached? ? @post.user.icon : '/placeholder.png', class: "img-thumbnail rounded-circle me-3", style: 'height:auto;width:50px;' %>
    <span class="h-100"><%= @post.user.username %></span>
  <% end %>
  <div class="card-body">
    <%= image_tag @post.image, class: "w-100" if @post.image.attached? %>
  </div>
  <div class="card-footer bg-transparent">
    <section>
      <%= render LikeComponent.new(post: @post, current_user: @current_user) %>
      <i class="bi bi-chat h4 me-3"></i>
      <i class="bi bi-send h4"></i>
    </section>
    <% if @post.caption.present? %>
      <div class="py-3">
        <span class="me-1 h6"><%= @post.user.username%></span>
        <span><%= @post.caption %></span>
      </div>
    <% end %>
  </div>
</div>
```

## æŠ•ç¨¿ã«ã„ã„ã­ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¡¨ç¤ºã™ã‚‹
* `app/components/post_component.html.erb`ã‚’ç·¨é›†

```erb
<div class="card mb-3">
  <%= link_to user_path(username: @post.user.username), class: "card-header d-flex align-items-center link-dark fw-bold", style: "text-decoration: none" do %>
    <%= image_tag @post.user.icon.attached? ? @post.user.icon : '/placeholder.png', class: "img-thumbnail rounded-circle me-3", style: 'height:auto;width:50px;' %>
    <span class="h-100"><%= @post.user.username %></span>
  <% end %>
  <div class="card-body">
    <%= image_tag @post.image, class: "w-100" if @post.image.attached? %>
  </div>
  <div class="card-footer bg-transparent">
    <section>
      <%= render LikeComponent.new(post: @post, current_user: @current_user) %>
      <i class="bi bi-chat h4 me-3"></i>
      <i class="bi bi-send h4"></i>
    </section>
    <div class="my-2">
      <% if @post.likes.present? %>
        <div class="py-3">
          <span class="me-1 h6 fw-bold"><%= link_to username = @post.likes.last.user.username, user_path(username: username),class: "text-decoration-none text-black" %></span>
          <span class="me-1 h6">ã€<span class="h6 fw-bold">ãã®ä»–</span>ãŒã€Œã„ã„ã­ï¼ã€ã—ã¾ã—ãŸ</span>
        </div>
      <% end %>
      <% if @post.caption.present? %>
        <div>
          <span class="me-1 h6"><%= @post.user.username %></span>
          <span><%= @post.caption %></span>
        </div>
      <% end %>
      <p class="text-muted mt-3"><%= @post.created_at.strftime('%-mæœˆ%-dæ—¥') %></p>
    </div>
  </div>
</div>
```

## ãƒ•ã‚©ãƒ­ãƒ¼ç”¨ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã™ã‚‹
* `$ rails g model Follow`
* `db/migrate/************_create_follows.rb`ã‚’ç·¨é›†ã™ã‚‹

```ruby
class CreateFollows < ActiveRecord::Migration[7.0]
  def change
    create_table :follows do |t|
      t.integer :from_user_id, null: false
      t.integer :to_user_id, null: false

      t.timestamps
      t.index :from_user_id
      t.index :to_user_id
      t.index [:from_user_id, :to_user_id], unique: true
    end
  end
end
```
* `rails db:migrate`

## ãƒ¢ãƒ‡ãƒ«ã«ãƒ•ã‚©ãƒ­ãƒ¼ç”¨ã®é–¢ä¿‚æ€§ã‚’è¨­å®šã™ã‚‹
* `app/models/follow.rb`

```ruby
class Follow < ApplicationRecord
  belongs_to :to_user, class_name: "User"
  belongs_to :from_user, class_name: "User"

  validates :to_user_id, uniqueness: { scope: :from_user_id, message: "ã™ã§ã«ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã¾ã™" }
end
```

* `app/models/user.rb`

```ruby
class User < ApplicationRecord
  HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX = /\A[a-zA-Z0-9]+\z/
  authenticates_with_sorcery!
  has_one_attached :icon

  validates :email, presence: true
  validates :username, presence: true, format: { with: HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX, message: "åŠè§’è‹±æ•°å­—ã®ã¿ä½¿ãˆã¾ã™" }
  validates :password, length: { minimum: 8 }, if: -> { new_record? || changes[:crypted_password] }
  validates :introduction, length: { maximum: 191 }

  has_many :posts, dependent: :destroy
  has_many :likes, dependent: :destroy
  has_many :follow_relationships, class_name: "Follow", foreign_key: :from_user_id, dependent: :destroy
  has_many :followed_relationships, class_name: "Follow", foreign_key: :to_user_id, dependent: :destroy
  has_many :followings, through: :follow_relationships, source: :to_user
  has_many :followers, through: :followed_relationships, source: :from_user
end
```

## ãƒ•ã‚©ãƒ­ãƒ¼ç”¨ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨­å®šã™ã‚‹
* `config/routes.rb`

```ruby
Rails.application.routes.draw do
  root "posts#index"
  resources :posts do
    resource :like, only: %i[create destroy]
  end
  resources :users, param: :username
  get 'login', to: 'user_sessions#new', as: 'login'
  post 'login', to: "user_sessions#create"
  delete 'logout', to: 'user_sessions#destroy', as: 'logout'
  resources :follows, only: [:create, :destroy] # è¿½åŠ 
end
```

## ãƒ•ã‚©ãƒ­ãƒ¼ç”¨ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ä½œæˆã™ã‚‹
* `$ rails g controller Follows --skip-template-engine`

```ruby
class FollowsController < ApplicationController
  def create
    current_user.follow_relationships.create(to_user_id: params[:user_id])
    redirect_back fallback_location: root_path
  end

  def destroy
    current_user.follow_relationships.find_by(to_user_id: params[:id]).destroy
    redirect_back fallback_location: root_path, status: :see_other
  end
end
```

## ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã«ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹
* `app/models/user.rb`ã«å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ•ã‚©ãƒ­ãƒ¼æ¸ˆã¿ã‹ã‚’åˆ¤å®šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 

```ruby
class User < ApplicationRecord
  HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX = /\A[a-zA-Z0-9]+\z/
  authenticates_with_sorcery!
  has_one_attached :icon

  validates :email, presence: true
  validates :username, presence: true, format: { with: HALF_WIDTH_ALPHANUMERIC_CHARACTERS_REGEX, message: "åŠè§’è‹±æ•°å­—ã®ã¿ä½¿ãˆã¾ã™" }
  validates :password, length: { minimum: 8 }, if: -> { new_record? || changes[:crypted_password] }
  validates :introduction, length: { maximum: 191 }

  has_many :posts, dependent: :destroy
  has_many :likes, dependent: :destroy
  has_many :follow_relationships, class_name: "Follow", foreign_key: :from_user_id, dependent: :destroy
  has_many :followed_relationships, class_name: "Follow", foreign_key: :to_user_id, dependent: :destroy
  has_many :followings, through: :follow_relationships, source: :to_user
  has_many :followers, through: :followed_relationships, source: :from_user

  def following?(user_id) # è¿½åŠ 
    User.find(user_id).in?(followings) # è¿½åŠ 
  end # è¿½åŠ 
end
```

* `app/views/users/show.html.erb`ã§è‡ªåˆ†ã®è©³ç´°ãƒšãƒ¼ã‚¸ãªã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†ã€ãã‚Œä»¥å¤–ã¯ãƒ•ã‚©ãƒ­ãƒ¼ç”¨ã®ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¦ã€ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼äººæ•°ã‚’è¡¨ç¤ºå‡ºæ¥ã‚‹ã‚ˆã†ã«ã—ãŸ

```ruby
<div class="w-75 mx-auto">
  <div class="d-flex justify-content-start m-5 align-items-center">
    <%= image_tag @user.icon.attached? ? @user.icon : '/placeholder.png', class: "img-thumbnail rounded-circle me-5", style: 'height:auto;width:200px;' %>
    <section class="mx-5">
      <div class="mb-3">
        <span class="h4 me-3"><%= @user.username %></span>
        <span>
          <% if @user.eql?(current_user) %>
            <%= link_to "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†", edit_user_path(current_user.username), class: "btn btn-outline-secondary" %>
          <% elsif current_user&.following?(@user.id) %>
            <%= link_to 'ãƒ•ã‚©ãƒ­ãƒ¼ä¸­', follow_path(@user), data: { turbo_method: :delete }, class: "btn btn-secondary btn-sm" %>
          <% else %>
            <%= link_to 'ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹', follows_path(user_id: @user.id), data: { turbo_method: :post }, class: "btn btn-primary btn-sm" %>
          <% end %>
        </span>
      </div>
      <div class="mb-3">
        <span class="me-3">æŠ•ç¨¿<%= @user.posts.size %>ä»¶</span>
        <span class="me-3">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼<%= @user.followers.size %>äºº</span>
        <span class="me-3">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­<%= @user.followings.size %>äºº</span>
      </div>
      <div>
        <p class="h4"><%= @user.fullname %></p>
        <p class="me-3"><%= @user.introduction %></p>
      </div>
    </section>
  </div>
  <hr class="w-100">
  <div class="container mt-5">
    <div class="row">
      <%= render MyPostComponent.with_collection(@user.posts) %>
    </div>
  </div>
</div>
```

## æŠ•ç¨¿ãŒãªã‹ã£ãŸå ´åˆã«è¡¨ç¤ºã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹
* `$ rails generate component User`

* `app/controllers/users_controller.rb`

```ruby
class UsersController < ApplicationController
  skip_before_action :require_login, only: %i[new create show]

  def index # è¿½åŠ 
    @users = User.where.not(id: User.first.followings.pluck(:id).push(User.first.id)) # è¿½åŠ 
  end # è¿½åŠ 

  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)
    if @user.save
      redirect_to login_path, notice: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ'
    else
      flash.now[:alert] = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'
      render :new, status: :unprocessable_entity
    end
  end

  def show
    @user = User.find_by(username: params[:username])
  end

  def edit
    @user = current_user
  end

  def update
    @user = current_user
    if @user.update(user_params)
      redirect_to user_path(username: current_user.username)
    else
      render :edit
    end
  end

  private

  def user_params
    params.require(:user).permit(:email, :fullname, :username, :password, :icon, :introduction)
  end
end
```

* `app/components/user_component.rb`

```ruby
# frozen_string_literal: true

class UserComponent < ViewComponent::Base
  def initialize(user:, current_user:)
    @user = user
    @current_user = current_user
  end
end
```

* `app/components/user_component.html.erb`

```erb
<div class="d-flex justify-content-between mb-3">
  <div>
    <%= image_tag @user.icon.attached? ? @user.icon : '/placeholder.png', class: "img-thumbnail rounded-circle me-1", style: 'height:auto;width:35px;' %>
    <%= @user.username %>
  </div>
  <div>
  <% if @current_user.following?(@user.id) %>
    <%= link_to 'ãƒ•ã‚©ãƒ­ãƒ¼ä¸­', follow_path(@user), data: { turbo_method: :delete }, class: "btn btn-secondary btn-sm" %>
  <% else %>
    <%= link_to 'ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹', follows_path(user_id: @user.id), data: { turbo_method: :post }, class: "btn btn-primary btn-sm" %>
  <% end %>
  </div>
</div>
```

* `app/views/users/index.html.erb`ã‚’ä½œæˆã™ã‚‹

```erb
<div class="m-5 mx-auto w-25">
  <div class="card">
    <div class="card-body">
      <div class='h4 text-black-50 mb-4 text-center card-header bg-transparent'>
        å‹é”ã‚’è¦‹ã¤ã‘ã‚ˆã†
      </div>
      <%= render UserComponent.with_collection(@users, current_user: current_user) %>
    </div>
  </div>
<div>
```

## æŠ•ç¨¿ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«å¤‰æ›´
* `app/models/post.rb`

```ruby
class Post < ApplicationRecord
  has_one_attached :image

  validates :image, presence: true
  validates :caption, length: { maximum: 191 }

  belongs_to :user
  has_many :likes, dependent: :destroy

  scope :followed_by, -> (user){ where(user_id: user.following_ids.push(user.id)) } # è¿½åŠ 
end
```

* `app/controllers/posts_controller.rb`

```ruby
class PostsController < ApplicationController
  skip_before_action :require_login, only: %i[index]

  def index
    if current_user.present? # å¤‰æ›´
      @posts = Post.followed_by(current_user).order(created_at: :desc) # å¤‰æ›´
    else # å¤‰æ›´
      @posts = Post.all.order(created_at: :desc) # å¤‰æ›´
    end # å¤‰æ›´
  end

  def new
    @post = Post.new
  end

  def create
    @post = current_user.posts.build(image: params[:post][:image], caption: params[:post][:caption])
    if @post.save
      redirect_to posts_path, notice: 'æŠ•ç¨¿ã‚’ä½œæˆã—ã¾ã—ãŸ'
    else
      flash.now[:alert] = 'æŠ•ç¨¿ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'
      render :new
    end
  end
end
```

* `app/views/posts/index.html.erb`

```erb
<div class="m-5 mx-auto w-50">
  <% if @posts.exists? %>
    <%= render PostComponent.with_collection(@posts, current_user: current_user) %>
  <% else %>
    <p>ãŸãã•ã‚“ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’é¢ç™½ã„æŠ•ç¨¿ã§ã„ã£ã±ã„ã«ã—ã‚ˆã†</p>
    <%= link_to 'å‹é”ã‚’è¦‹ã¤ã‘ã«è¡Œã', users_path %>
  <% end %>
</div>
